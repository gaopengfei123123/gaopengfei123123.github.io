<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>&lt;hello-world/&gt;</title>
  
  <subtitle>代码改变世界</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.justwe.site/"/>
  <updated>2019-01-30T10:12:38.839Z</updated>
  <id>http://blog.justwe.site/</id>
  
  <author>
    <name>GPF</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>关于 Go 的 for Range 上的一个坑</title>
    <link href="http://blog.justwe.site/2019/01/30/go-for-range-error/"/>
    <id>http://blog.justwe.site/2019/01/30/go-for-range-error/</id>
    <published>2019-01-30T08:22:57.000Z</published>
    <updated>2019-01-30T10:12:38.839Z</updated>
    
    <content type="html"><![CDATA[<p><code>range</code>作为go的一个语法糖在进行迭代的时候是很方便的, 但6是传址赋值的时候需要小心一点</p><a id="more"></a><h5 id="出现问题"><a href="#出现问题" class="headerlink" title="出现问题"></a>出现问题</h5><p>直接上代码:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">slice := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">myMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]*<span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> index, value := <span class="keyword">range</span> slice &#123;</span><br><span class="line">fmt.Printf(<span class="string">"value's memery address: %v | value's value: %v \n"</span>, &amp;value, value)</span><br><span class="line">myMap[index] = &amp;value</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"=====new map by range====="</span>)</span><br><span class="line">fmt.Printf(<span class="string">"result: %v \n"</span>, myMap)</span><br><span class="line">prtMap(myMap)</span><br><span class="line"></span><br><span class="line">myMap2 := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]*<span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(slice); i++ &#123;</span><br><span class="line">myMap2[i] = &amp;slice[i]</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"=====new map by for====="</span>)</span><br><span class="line">fmt.Printf(<span class="string">"result: %v \n"</span>, myMap2)</span><br><span class="line">prtMap(myMap2)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prtMap</span><span class="params">(myMap <span class="keyword">map</span>[<span class="keyword">int</span>]*<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> key, value := <span class="keyword">range</span> myMap &#123;</span><br><span class="line">fmt.Printf(<span class="string">"map[%v]=%v\n"</span>, key, *value)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">value<span class="string">'s memery address: 0xc0000160a8 | value'</span>s value: 0</span><br><span class="line">value<span class="string">'s memery address: 0xc0000160a8 | value'</span>s value: 1</span><br><span class="line">value<span class="string">'s memery address: 0xc0000160a8 | value'</span>s value: 2</span><br><span class="line">value<span class="string">'s memery address: 0xc0000160a8 | value'</span>s value: 3</span><br><span class="line">=====new map by range=====</span><br><span class="line">result: map[0:0xc0000160a8 1:0xc0000160a8 2:0xc0000160a8 3:0xc0000160a8]</span><br><span class="line">map[1]=3</span><br><span class="line">map[2]=3</span><br><span class="line">map[3]=3</span><br><span class="line">map[0]=3</span><br><span class="line">i<span class="string">'s memery address: 0xc000016120 | value: 0</span></span><br><span class="line"><span class="string">i'</span>s memery address: 0xc000016120 | value: 1</span><br><span class="line">i<span class="string">'s memery address: 0xc000016120 | value: 2</span></span><br><span class="line"><span class="string">i'</span>s memery address: 0xc000016120 | value: 3</span><br><span class="line">=====new map by <span class="keyword">for</span>=====</span><br><span class="line">result: map[2:0xc00001c110 3:0xc00001c118 0:0xc00001c100 1:0xc00001c108]</span><br><span class="line">map[2]=2</span><br><span class="line">map[3]=3</span><br><span class="line">map[0]=0</span><br><span class="line">map[1]=1</span><br></pre></td></tr></table></figure></p><h5 id="猜测原因"><a href="#猜测原因" class="headerlink" title="猜测原因"></a>猜测原因</h5><p><code>range</code> 和 <code>for</code>  进行赋值操作<strong>只执行了一次</strong>, 因此在上面那个例子中 <code>value</code>和<code>i</code>的内存地址在循环的时候都没变过, 在进行值拷贝的时候是没问题的, 但是一旦加上 <code>&amp;</code> 的时候就变得很危险了, 造成的结果就是上面那个例子中的问题, 新数组存的都是同一个内存地址, 在 for 循环的时候因为只是利用的索引, 没有直接用到切片的值而不会引发这些问题, 在 range 的时候会出现 key,value 同时出现,那么就要小心处理了, 因为这里的value并不是切片中的原值, 而是一个拷贝出来的</p><p><a href="https://www.jianshu.com/p/35c2662b5b57" target="_blank" rel="noopener">Go Range 内部实现</a><br><a href="https://studygolang.com/articles/9701" target="_blank" rel="noopener">go语言坑之for range</a></p><h5 id="类似的问题"><a href="#类似的问题" class="headerlink" title="类似的问题"></a>类似的问题</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">4</span>; i++ &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"i is %d \n"</span>, i)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输出 4,4,4,4</span><br></pre></td></tr></table></figure><p>这个和上一个的问题还不一样, 这个就是闭包的执行顺序以及变量作用域的问题, 在执行闭包的时候for循环已经执行完毕,此时i=4, 接下来才会执行闭包内的函数, 规避这个问题也简单, 把变量的作用域改一下就行, 还有就是函数参数的值拷贝特点<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">4</span>; i++ &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"i is %d \n"</span>, i)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><a href="https://studygolang.com/articles/4313" target="_blank" rel="noopener">闭包和变量作用域</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;range&lt;/code&gt;作为go的一个语法糖在进行迭代的时候是很方便的, 但6是传址赋值的时候需要小心一点&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://blog.justwe.site/categories/go/"/>
    
    
      <category term="range" scheme="http://blog.justwe.site/tags/range/"/>
    
  </entry>
  
  <entry>
    <title>转 Mac上一些好玩的命令行工具</title>
    <link href="http://blog.justwe.site/2019/01/18/tool-mac-terminal-awesome/"/>
    <id>http://blog.justwe.site/2019/01/18/tool-mac-terminal-awesome/</id>
    <published>2019-01-18T10:26:42.000Z</published>
    <updated>2019-01-21T09:55:22.514Z</updated>
    
    <content type="html"><![CDATA[<p>mac上一些有意思的命令行小工具</p><a id="more"></a><h3 id="asciinema-和-svg-term"><a href="#asciinema-和-svg-term" class="headerlink" title="asciinema 和  svg-term"></a>asciinema 和  svg-term</h3><p>assiiname 是用来命令行录屏的, svg-term 将文件转换成svg动图, 这个做截屏很方便</p><p>安装:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install asciinema</span><br><span class="line">npm install -g svg-term</span><br></pre></td></tr></table></figure></p><p>使用方式:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">asciinema rec cast.json   // 开始录制, 数据保存在cast.json, 按 ctrl+d 保存</span><br><span class="line">cat cast.json | svg-term-cli   //输出svg文件</span><br></pre></td></tr></table></figure></p><p>比如下图<br><img src="/images/terminal/demo.svg" alt="图片"><br>缺点就是如果文件特别大帧率受到严重的影响</p><h4 id="sl-和-cmatrix-小特效玩具"><a href="#sl-和-cmatrix-小特效玩具" class="headerlink" title="sl 和 cmatrix 小特效玩具"></a>sl 和 cmatrix 小特效玩具</h4><p>安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install sl</span><br><span class="line">brew install cmatrix</span><br></pre></td></tr></table></figure></p><p>平时装哔用的</p><h4 id="bat"><a href="#bat" class="headerlink" title="bat"></a>bat</h4><p>安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install bat</span><br></pre></td></tr></table></figure></p><p>替代 <code>cat</code> 命令, 支持代码高亮</p><h4 id="ncdu-清理磁盘"><a href="#ncdu-清理磁盘" class="headerlink" title="ncdu 清理磁盘"></a>ncdu 清理磁盘</h4><p>如标题, 清理磁盘, 直接运行就行</p><p>安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install ncdu</span><br></pre></td></tr></table></figure></p><p>收藏链接:<br><a href="https://juejin.im/post/5c3dcecef265da6163024b1c" target="_blank" rel="noopener">优秀的命令行工具整理（一）</a><br><a href="https://juejin.im/post/5c418e2df265da616501d461" target="_blank" rel="noopener">优秀的命令行工具整理（二）</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;mac上一些有意思的命令行小工具&lt;/p&gt;
    
    </summary>
    
      <category term="tools" scheme="http://blog.justwe.site/categories/tools/"/>
    
    
      <category term="tools" scheme="http://blog.justwe.site/tags/tools/"/>
    
      <category term="mac" scheme="http://blog.justwe.site/tags/mac/"/>
    
      <category term="terminal" scheme="http://blog.justwe.site/tags/terminal/"/>
    
  </entry>
  
  <entry>
    <title>用Gorilla Websocket 搞一个聊天室</title>
    <link href="http://blog.justwe.site/2019/01/15/go-chat/"/>
    <id>http://blog.justwe.site/2019/01/15/go-chat/</id>
    <published>2019-01-15T03:27:36.000Z</published>
    <updated>2019-01-15T05:47:41.682Z</updated>
    
    <content type="html"><![CDATA[<p>这个demo实现了:</p><ol><li>消息广播</li><li>心跳检测</li></ol><p>提供了一个通过命令行来进行聊天的例子</p><a id="more"></a><p>具体逻辑都在 websocket.go 这个文件里</p><p>这里的核心就是 <code>aliveList</code> 这个全局变量, 负责把消息分发给各客户端, 事件用channel来传递,  减少阻塞</p><p>单个链接会在 <code>aliveList</code> 中注册, ConnList 就是所有活跃的链接</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AliveList 当前在线列表</span></span><br><span class="line"><span class="keyword">type</span> AliveList <span class="keyword">struct</span> &#123;</span><br><span class="line">ConnList  <span class="keyword">map</span>[<span class="keyword">string</span>]*Client</span><br><span class="line">register  <span class="keyword">chan</span> *Client</span><br><span class="line">destroy   <span class="keyword">chan</span> *Client</span><br><span class="line">broadcast <span class="keyword">chan</span> Message</span><br><span class="line">cancel    <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">Len       <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Client socket客户端</span></span><br><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> &#123;</span><br><span class="line">ID     <span class="keyword">string</span></span><br><span class="line">conn   *websocket.Conn</span><br><span class="line">cancel <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>服务启动后会执行事件监听循环</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动监听</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(al *AliveList)</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.Println(<span class="string">"开始监听注册事件"</span>)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> client := &lt;-al.register:</span><br><span class="line">log.Println(<span class="string">"注册事件:"</span>, client.ID)</span><br><span class="line">al.ConnList[client.ID] = client</span><br><span class="line">al.Len++</span><br><span class="line">al.SysBroadcast(ConnectedMessage, Message&#123;</span><br><span class="line">ID:      client.ID,</span><br><span class="line">Content: <span class="string">"connected"</span>,</span><br><span class="line">SentAt:  time.Now().Unix(),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> client := &lt;-al.destroy:</span><br><span class="line">log.Println(<span class="string">"销毁事件:"</span>, client.ID)</span><br><span class="line">err := client.conn.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">"destroy Error: %v \n"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">delete</span>(al.ConnList, client.ID)</span><br><span class="line">al.Len--</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> message := &lt;-al.broadcast:</span><br><span class="line">log.Printf(<span class="string">"广播事件: %s %s %d \n"</span>, message.ID, message.Content, message.Type)</span><br><span class="line"><span class="keyword">for</span> id := <span class="keyword">range</span> al.ConnList &#123;</span><br><span class="line"><span class="keyword">if</span> id != message.ID &#123;</span><br><span class="line"></span><br><span class="line">err := al.sendMessage(id, message)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"broadcastError: "</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> sign := &lt;-al.cancel:</span><br><span class="line">log.Println(<span class="string">"终止事件: "</span>, sign)</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为消息的类型比较多, 单纯字符串无法满足需求, 就选用了比较常用的json格式去传递, 消息目前分:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line"><span class="comment">// SystemMessage 系统消息</span></span><br><span class="line">SystemMessage = <span class="literal">iota</span></span><br><span class="line"><span class="comment">// BroadcastMessage 广播消息(正常的消息)</span></span><br><span class="line">BroadcastMessage</span><br><span class="line"><span class="comment">// HeartBeatMessage 心跳消息</span></span><br><span class="line">HeartBeatMessage</span><br><span class="line"><span class="comment">// ConnectedMessage 上线通知</span></span><br><span class="line">ConnectedMessage</span><br><span class="line"><span class="comment">// DisconnectedMessage 下线通知</span></span><br><span class="line">DisconnectedMessage</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Message 消息体结构</span></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">ID      <span class="keyword">string</span></span><br><span class="line">Content <span class="keyword">string</span></span><br><span class="line">SentAt  <span class="keyword">int64</span></span><br><span class="line">Type    <span class="keyword">int</span>     <span class="comment">// &lt;- SystemMessage 等类型就是这里了</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果有空闲时间就再搞搞多聊天室的实现, 以及优化一下目前的事件循环逻辑<br><del>如果还有更多的余力, 就搞一个好看点的客户端?</del></p><p><a href="https://github.com/gaopengfei123123/chat" target="_blank" rel="noopener">demo地址</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这个demo实现了:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;消息广播&lt;/li&gt;
&lt;li&gt;心跳检测&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;提供了一个通过命令行来进行聊天的例子&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://blog.justwe.site/categories/go/"/>
    
    
      <category term="go" scheme="http://blog.justwe.site/tags/go/"/>
    
      <category term="websocket" scheme="http://blog.justwe.site/tags/websocket/"/>
    
  </entry>
  
  <entry>
    <title>转 Yii2 断线重连问题</title>
    <link href="http://blog.justwe.site/2018/12/19/yii-mysql/"/>
    <id>http://blog.justwe.site/2018/12/19/yii-mysql/</id>
    <published>2018-12-19T03:31:00.000Z</published>
    <updated>2018-12-19T03:40:02.627Z</updated>
    
    <content type="html"><![CDATA[<p>yii2 + swoole 的模式下因为使用swoole做的常驻内存服务, 那么之前的设计思路会有一点偏差, 不是第一眼能看到的就是 <code>mysql has gone away</code>的问题</p><p>目前解决思路就是当sql命令报错<code>mysql has gone away</code>的时候就断开重连再重新执行一次</p><a id="more"></a><p>参考 <a href="https://www.yiichina.com/topic/7296" target="_blank" rel="noopener">Yii2实现mysql断线重连</a></p><p>重写一个command类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">common</span>\<span class="title">components</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">use</span> <span class="title">Yii</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增加执行sql时断开重连</span></span><br><span class="line"><span class="comment">     * 数据库连接断开异常</span></span><br><span class="line"><span class="comment">     * errorInfo = [''HY000',2006,'错误信息']</span></span><br><span class="line"><span class="comment">     * Class Command</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@package</span> common\components</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Command</span> <span class="keyword">extends</span> \<span class="title">yii</span>\<span class="title">db</span>\<span class="title">Command</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> EVENT_DISCONNECT = <span class="string">'disconnect'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 处理修改类型sql的断线重连问题</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> \Exception</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> \yii\db\Exception</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">parent</span>::execute();</span><br><span class="line">            &#125;<span class="keyword">catch</span>(\<span class="keyword">Exception</span> $e)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;handleException($e))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">parent</span>::execute();</span><br><span class="line">                <span class="keyword">throw</span> $e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 处理查询类sql断线重连问题</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> string $method</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> null $fetchMode</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> \Exception</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> \yii\db\Exception</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">queryInternal</span><span class="params">($method, $fetchMode = null)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">parent</span>::queryInternal($method, $fetchMode);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(\<span class="keyword">Exception</span> $e)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;handleException($e))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">parent</span>::queryInternal($method, $fetchMode);</span><br><span class="line">                <span class="keyword">throw</span> $e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 处理执行sql时捕获的异常信息</span></span><br><span class="line"><span class="comment">         * 并且根据异常信息来决定是否需要重新连接数据库</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> \Exception $e</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> bool true: 需要重新执行sql false: 不需要重新执行sql</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">handleException</span><span class="params">(\Exception $e)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">//如果不是yii\db\Exception异常抛出该异常或者不是MySQL server has gone away</span></span><br><span class="line">            $offset = stripos($e-&gt;getMessage(),<span class="string">'MySQL server has gone away'</span>);</span><br><span class="line">            <span class="keyword">if</span>(($e <span class="keyword">instanceof</span> \yii\db\<span class="keyword">Exception</span>) == <span class="keyword">false</span> <span class="keyword">OR</span> $offset === <span class="keyword">false</span>)</span><br><span class="line">                <span class="comment">//OR $e-&gt;errorInfo[0] != 'HY000' OR $e-&gt;errorInfo[1] != 2006)</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;trigger(<span class="keyword">static</span>::EVENT_DISCONNECT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将pdo设置从null</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;pdoStatement = <span class="keyword">NULL</span>;</span><br><span class="line">            <span class="comment">//$this-&gt;db-&gt;resetPdo();</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;db-&gt;close();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在配置文件中关于db的配置给加上指定的class<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'components'</span> =&gt; [</span><br><span class="line">            <span class="string">'db'</span> =&gt; [</span><br><span class="line">                <span class="string">'class'</span>   =&gt; <span class="string">'yii\db\Connection'</span>,</span><br><span class="line">                <span class="string">'commandClass'</span> =&gt; <span class="string">'common\components\Command'</span>,<span class="comment">// 加上这个</span></span><br><span class="line">                <span class="string">'username'</span> =&gt; <span class="string">'XXX'</span>,</span><br><span class="line">                <span class="string">'password'</span> =&gt; <span class="string">'XXX'</span>,</span><br><span class="line">                <span class="string">'dsn'</span> =&gt; <span class="string">'mysql:host=XXX;dbname=XXX;port=3306'</span>,</span><br><span class="line">            ],</span><br><span class="line">        ],</span><br><span class="line">    ];</span><br></pre></td></tr></table></figure></p><p>相关文章:<br><a href="https://www.yiichina.com/topic/7296" target="_blank" rel="noopener">Yii2实现mysql断线重连</a><br><a href="https://blog.csdn.net/cenfei78325747/article/details/7854611" target="_blank" rel="noopener">在mysql中connection设置和wait-timeout的设置</a><br><a href="https://blog.csdn.net/csCrazybing/article/details/53303807" target="_blank" rel="noopener">查看mysql连接情况，以及连接超时时间设置</a><br><a href="https://blog.csdn.net/cor_twi/article/details/53098740" target="_blank" rel="noopener">源码剖析Yii错误 Invalid parameter number: no parameters were bound</a><br><a href="https://blog.csdn.net/cor_twi/article/details/52884730" target="_blank" rel="noopener">Yii 数据库重连告别General error: 2006 MySQL server has gone away</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;yii2 + swoole 的模式下因为使用swoole做的常驻内存服务, 那么之前的设计思路会有一点偏差, 不是第一眼能看到的就是 &lt;code&gt;mysql has gone away&lt;/code&gt;的问题&lt;/p&gt;
&lt;p&gt;目前解决思路就是当sql命令报错&lt;code&gt;mysql has gone away&lt;/code&gt;的时候就断开重连再重新执行一次&lt;/p&gt;
    
    </summary>
    
      <category term="yii2" scheme="http://blog.justwe.site/categories/yii2/"/>
    
    
      <category term="yii2" scheme="http://blog.justwe.site/tags/yii2/"/>
    
  </entry>
  
  <entry>
    <title>Go Mysql数据库连接池的使用</title>
    <link href="http://blog.justwe.site/2018/12/17/go-mysql-pool/"/>
    <id>http://blog.justwe.site/2018/12/17/go-mysql-pool/</id>
    <published>2018-12-17T06:48:26.000Z</published>
    <updated>2018-12-17T07:28:32.770Z</updated>
    
    <content type="html"><![CDATA[<p>建立一个mysql连接池将极大的缩短应用的响应时间, 减少频繁的io开销以及gc, 这在golang里面也是很容易就实现的</p><a id="more"></a><p>示例代码:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"database/sql"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">_ <span class="string">"github.com/GO-SQL-Driver/MySQL"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">db, _ = sql.Open(<span class="string">"mysql"</span>, <span class="string">"root:123123@tcp(localhost:33060)/go?charset=utf8"</span>)</span><br><span class="line"><span class="comment">// 设置最大连接数</span></span><br><span class="line">db.SetMaxOpenConns(<span class="number">300</span>)</span><br><span class="line"><span class="comment">// 设置最大空闲连接数</span></span><br><span class="line">db.SetMaxIdleConns(<span class="number">100</span>)</span><br><span class="line"><span class="comment">// 设置每个链接的过期时间</span></span><br><span class="line">db.SetConnMaxLifetime(time.Second * <span class="number">5</span>)</span><br><span class="line">err := db.Ping()</span><br><span class="line">checkErr(err)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">startServer(<span class="string">":9999"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startServer</span><span class="params">(port <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">http.HandleFunc(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">record := doSomething()</span><br><span class="line">fmt.Fprintln(w, record)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"listening http://localhost%s\n"</span>, port)</span><br><span class="line">err := http.ListenAndServe(port, <span class="literal">nil</span>)</span><br><span class="line">checkErr(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething</span><span class="params">()</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">string</span></span> &#123;</span><br><span class="line">rows, err := db.Query(<span class="string">"SELECT * FROM test LIMIT 1"</span>)</span><br><span class="line">checkErr(err)</span><br><span class="line"><span class="keyword">defer</span> rows.Close()</span><br><span class="line"></span><br><span class="line">columns, _ := rows.Columns()</span><br><span class="line">scanArgs := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="built_in">len</span>(columns))</span><br><span class="line">values := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="built_in">len</span>(columns))</span><br><span class="line"><span class="keyword">for</span> j := <span class="keyword">range</span> values &#123;</span><br><span class="line">scanArgs[j] = &amp;values[j]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">record := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line"><span class="comment">//将行数据保存到record字典</span></span><br><span class="line">err = rows.Scan(scanArgs...)</span><br><span class="line"><span class="keyword">for</span> i, col := <span class="keyword">range</span> values &#123;</span><br><span class="line"><span class="keyword">if</span> col != <span class="literal">nil</span> &#123;</span><br><span class="line">record[columns[i]] = <span class="keyword">string</span>(col.([]<span class="keyword">byte</span>))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fmt.Println(record)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> record</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething2</span><span class="params">()</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">string</span></span> &#123;</span><br><span class="line">dbConn, _ := sql.Open(<span class="string">"mysql"</span>, <span class="string">"root:123123@tcp(localhost:33060)/go?charset=utf8"</span>)</span><br><span class="line"><span class="keyword">defer</span> dbConn.Close()</span><br><span class="line"></span><br><span class="line">rows, err := dbConn.Query(<span class="string">"SELECT * FROM test LIMIT 1"</span>)</span><br><span class="line">checkErr(err)</span><br><span class="line"><span class="keyword">defer</span> rows.Close()</span><br><span class="line"></span><br><span class="line">columns, _ := rows.Columns()</span><br><span class="line">scanArgs := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="built_in">len</span>(columns))</span><br><span class="line">values := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="built_in">len</span>(columns))</span><br><span class="line"><span class="keyword">for</span> j := <span class="keyword">range</span> values &#123;</span><br><span class="line">scanArgs[j] = &amp;values[j]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">record := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line"><span class="comment">//将行数据保存到record字典</span></span><br><span class="line">err = rows.Scan(scanArgs...)</span><br><span class="line"><span class="keyword">for</span> i, col := <span class="keyword">range</span> values &#123;</span><br><span class="line"><span class="keyword">if</span> col != <span class="literal">nil</span> &#123;</span><br><span class="line">record[columns[i]] = <span class="keyword">string</span>(col.([]<span class="keyword">byte</span>))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fmt.Println(record)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> record</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkErr</span><span class="params">(err error)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试代码:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main_test.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"testing"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDoSomething</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">record := doSomething()</span><br><span class="line"></span><br><span class="line">t.Log(record)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkDoSomething</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">doSomething()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkDoSomethingParallel</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">b.RunParallel(<span class="function"><span class="keyword">func</span><span class="params">(pb *testing.PB)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> pb.Next() &#123;</span><br><span class="line">doSomething()</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkDoSomethingWithoutPoll</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">doSomething2()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkDoSomethingWithoutPollParallel</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">b.RunParallel(<span class="function"><span class="keyword">func</span><span class="params">(pb *testing.PB)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> pb.Next() &#123;</span><br><span class="line">doSomething2()</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试输出对比:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ go <span class="built_in">test</span> --bench=.</span><br><span class="line"></span><br><span class="line">goos: darwin</span><br><span class="line">goarch: amd64</span><br><span class="line">BenchmarkDoSomething-4                             20000             67898 ns/op</span><br><span class="line">BenchmarkDoSomethingParallel-4                     50000             29347 ns/op</span><br><span class="line">BenchmarkDoSomethingWithoutPoll-4                   1000           8400516 ns/op</span><br><span class="line">BenchmarkDoSomethingWithoutPollParallel-4           2000           8167164 ns/op</span><br><span class="line">PASS</span><br><span class="line">ok      _/Users/gpf/Documents/go/code/mysql_curd/pool   28.857s</span><br></pre></td></tr></table></figure></p><p>关键就是这几个方法:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db, _ = sql.Open(<span class="string">"mysql"</span>, <span class="string">"root:123123@tcp(localhost:33060)/go?charset=utf8"</span>)</span><br><span class="line"><span class="comment">// 设置最大连接数</span></span><br><span class="line">db.SetMaxOpenConns(<span class="number">300</span>)</span><br><span class="line"><span class="comment">// 设置最大空闲连接数</span></span><br><span class="line">db.SetMaxIdleConns(<span class="number">100</span>)</span><br><span class="line"><span class="comment">// 设置每个链接的过期时间</span></span><br><span class="line">db.SetConnMaxLifetime(time.Second * <span class="number">5</span>)</span><br></pre></td></tr></table></figure></p><p>设置超时时间很有必要, 避免出现server端主动关闭的情况 <code>mysql has gone away...</code></p><p><a href="http://www.01happy.com/golang-go-sql-drive-mysql-connection-pooling/" target="_blank" rel="noopener">代码来源</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;建立一个mysql连接池将极大的缩短应用的响应时间, 减少频繁的io开销以及gc, 这在golang里面也是很容易就实现的&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://blog.justwe.site/categories/go/"/>
    
    
      <category term="go" scheme="http://blog.justwe.site/tags/go/"/>
    
      <category term="mysql" scheme="http://blog.justwe.site/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>Go里的点点点语法</title>
    <link href="http://blog.justwe.site/2018/12/14/go-dotdotdot/"/>
    <id>http://blog.justwe.site/2018/12/14/go-dotdotdot/</id>
    <published>2018-12-14T02:37:32.000Z</published>
    <updated>2018-12-14T02:49:03.449Z</updated>
    
    <content type="html"><![CDATA[<p>golang 代码里面有时会出现 <code>...</code> 这个操作, 初次看到也是摸不到头脑,<br>其实他是用来做数组的析构用的</p><a id="more"></a><p>举个例子就明白了:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">pm := []<span class="keyword">string</span>&#123;<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>&#125;</span><br><span class="line">test(<span class="string">"abc"</span>, pm...) <span class="comment">// 相当于 test("abc", "a", "b", "c")</span></span><br><span class="line"></span><br><span class="line">ap := []<span class="keyword">string</span>&#123;<span class="string">"f"</span>, <span class="string">"g"</span>&#125;</span><br><span class="line">rs := <span class="built_in">append</span>(pm, ap...)  <span class="comment">// 相当于 append(pm, ap[0], ap[1], 以此类推)</span></span><br><span class="line">fmt.Println(<span class="string">"rs:"</span>, rs)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">(name <span class="keyword">string</span>, pms ...<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"output name:"</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> pms &#123;</span><br><span class="line">fmt.Printf(<span class="string">"k: %v, v: %v \n"</span>, k, v)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output name: abc</span><br><span class="line">k: 0, v: a</span><br><span class="line">k: 1, v: b</span><br><span class="line">k: 2, v: c</span><br><span class="line">rs: [a b c f g]</span><br></pre></td></tr></table></figure><p>这里做了两个示例: </p><ol><li><p>在func中的 <code>...</code> eg: <code>func test(name string, pms ...string)</code><br>代表着不限参数数量, 而多出的参数都放在了 <code>var pms []string</code> 这个数组当中, 在go中典型的使用例子就是 <code>fmt.Print</code> 这一系列的方法</p></li><li><p>在传参的时候使用<code>...</code> 是用来表示将数组中每个元素单独传入函数中<br>较长用的就是出现数组合并的时候, 使用<code>append()</code> 方法时:<br>这样写正确</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ap := []<span class="keyword">string</span>&#123;<span class="string">"f"</span>, <span class="string">"g"</span>&#125;</span><br><span class="line">   rs := <span class="built_in">append</span>(pm, ap...)  <span class="comment">// 相当于 append(pm, ap[0], ap[1], 以此类推)</span></span><br></pre></td></tr></table></figure></li></ol><p>这样写就报错<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ap := []<span class="keyword">string</span>&#123;<span class="string">"f"</span>, <span class="string">"g"</span>&#125;</span><br><span class="line">rs := <span class="built_in">append</span>(pm, ap)</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;golang 代码里面有时会出现 &lt;code&gt;...&lt;/code&gt; 这个操作, 初次看到也是摸不到头脑,&lt;br&gt;其实他是用来做数组的析构用的&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://blog.justwe.site/categories/go/"/>
    
    
      <category term="go" scheme="http://blog.justwe.site/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>Crontab 设置一小时执行一次</title>
    <link href="http://blog.justwe.site/2018/12/11/linux-crontab/"/>
    <id>http://blog.justwe.site/2018/12/11/linux-crontab/</id>
    <published>2018-12-11T02:55:47.000Z</published>
    <updated>2018-12-11T03:21:59.706Z</updated>
    
    <content type="html"><![CDATA[<p>如果主管给你个任务, 让你每小时执行一次脚本, 是不是就是这样:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* */1 * * * xxxxx.bash</span><br></pre></td></tr></table></figure></p><p>这样就错了呦~</p><a id="more"></a><p>以上产生的结果是每分钟执行一次, 因为从匹配角度来看每分钟都符合规则, 继而执行命令</p><p>因此对于整点定时任务有两种写法:</p><p>每<strong>整点</strong>执行一次:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 */1 * * * xxxxx.bash</span><br></pre></td></tr></table></figure></p><p>每<strong>隔60分钟</strong>执行一次:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/60 * * * * xxxxx.bash</span><br></pre></td></tr></table></figure></p><p>注意我的描述啊, 整点和隔60分钟其实是两个东西, 根据具体业务要求去使用它</p><p><img src="/images/crontab.png" alt=""></p><p>关于定时器这里有三个示例:</p><ol><li><p>在上午8点到11点的第3和第15分钟执行 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3,15 8-11 * * * <span class="built_in">command</span></span><br></pre></td></tr></table></figure></li><li><p>每隔两天的上午8点到11点的第3和第15分钟执行 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3,15 8-11 */2 * * <span class="built_in">command</span></span><br></pre></td></tr></table></figure></li><li><p>每个星期一的上午8点到11点的第3和第15分钟执行 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3,15 8-11 * * 1 <span class="built_in">command</span></span><br></pre></td></tr></table></figure></li></ol><p>详细的crontab操作可以参考这篇博客:<br><a href="https://blog.csdn.net/u014726937/article/details/51182666" target="_blank" rel="noopener">crontab–定时器命令</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;如果主管给你个任务, 让你每小时执行一次脚本, 是不是就是这样:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;* */1 * * * xxxxx.bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这样就错了呦~&lt;/p&gt;
    
    </summary>
    
      <category term="tools" scheme="http://blog.justwe.site/categories/tools/"/>
    
    
      <category term="linux" scheme="http://blog.justwe.site/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>通过Channel控制并发数量</title>
    <link href="http://blog.justwe.site/2018/12/04/go-channel-waitgroup/"/>
    <id>http://blog.justwe.site/2018/12/04/go-channel-waitgroup/</id>
    <published>2018-12-04T06:14:30.000Z</published>
    <updated>2018-12-04T06:26:24.991Z</updated>
    
    <content type="html"><![CDATA[<p>使用 <code>go</code> 关键字有时候需要控制一下并发的数量, 但不至于去修改 <code>runtime.GOMAXPROCS</code> 这个数值, 这里就用到了缓冲<code>channel</code>的特性</p><a id="more"></a><p>demo:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> pool</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// WaitGroup 一个异步结构体</span></span><br><span class="line"><span class="keyword">type</span> WaitGroup <span class="keyword">struct</span> &#123;</span><br><span class="line">workChan <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">wg       sync.WaitGroup</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewPool 生成一个工作池, coreNum 限制</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPool</span><span class="params">(coreNum <span class="keyword">int</span>)</span> *<span class="title">WaitGroup</span></span> &#123;</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, coreNum)</span><br><span class="line"><span class="keyword">return</span> &amp;WaitGroup&#123;</span><br><span class="line">workChan: ch,</span><br><span class="line">wg:       sync.WaitGroup&#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add 添加</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ap *WaitGroup)</span> <span class="title">Add</span><span class="params">(num <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; num; i++ &#123;</span><br><span class="line">ap.workChan &lt;- i</span><br><span class="line">ap.wg.Add(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Done 完结</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ap *WaitGroup)</span> <span class="title">Done</span><span class="params">()</span></span> &#123;</span><br><span class="line">LOOP:</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-ap.workChan:</span><br><span class="line"><span class="keyword">break</span> LOOP</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">ap.wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wait 等待</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ap *WaitGroup)</span> <span class="title">Wait</span><span class="params">()</span></span> &#123;</span><br><span class="line">ap.wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>test:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pool</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"testing"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestRun</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">work := NewPool(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">50</span>; i++ &#123;</span><br><span class="line">work.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> testFunc(i, work)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">"waiting..."</span>)</span><br><span class="line">work.Wait()</span><br><span class="line">t.Log(<span class="string">"done"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testFunc</span><span class="params">(i <span class="keyword">int</span>, wg *WaitGroup)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">fmt.Println(time.Now().Format(<span class="string">"2006-01-02T15:04:05Z07:00"</span>), <span class="string">"output: "</span>, i)</span><br><span class="line">time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">fmt.Println(time.Now().Format(<span class="string">"2006-01-02T15:04:05Z07:00"</span>), <span class="string">"output: "</span>, i, <span class="string">"done"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">2018-12-04T14:22:27+08:00 output:  3</span><br><span class="line">2018-12-04T14:22:27+08:00 output:  1</span><br><span class="line">2018-12-04T14:22:27+08:00 output:  0</span><br><span class="line">2018-12-04T14:22:27+08:00 output:  2</span><br><span class="line">2018-12-04T14:22:28+08:00 output:  3 <span class="keyword">done</span></span><br><span class="line">2018-12-04T14:22:28+08:00 output:  0 <span class="keyword">done</span></span><br><span class="line">2018-12-04T14:22:28+08:00 output:  1 <span class="keyword">done</span></span><br><span class="line">2018-12-04T14:22:28+08:00 output:  5</span><br><span class="line">2018-12-04T14:22:28+08:00 output:  6</span><br><span class="line">2018-12-04T14:22:28+08:00 output:  2 <span class="keyword">done</span></span><br><span class="line">2018-12-04T14:22:28+08:00 output:  7</span><br><span class="line">2018-12-04T14:22:28+08:00 output:  4</span><br><span class="line">2018-12-04T14:22:29+08:00 output:  4 <span class="keyword">done</span></span><br><span class="line">2018-12-04T14:22:29+08:00 output:  8</span><br><span class="line">2018-12-04T14:22:29+08:00 output:  7 <span class="keyword">done</span></span><br><span class="line">2018-12-04T14:22:29+08:00 output:  6 <span class="keyword">done</span></span><br><span class="line">.....</span><br></pre></td></tr></table></figure><p>这里还是要带上 <code>sync.WaitGroup</code>, 保证最后一次循环时携程不会过早退出</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;使用 &lt;code&gt;go&lt;/code&gt; 关键字有时候需要控制一下并发的数量, 但不至于去修改 &lt;code&gt;runtime.GOMAXPROCS&lt;/code&gt; 这个数值, 这里就用到了缓冲&lt;code&gt;channel&lt;/code&gt;的特性&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://blog.justwe.site/categories/go/"/>
    
    
      <category term="go" scheme="http://blog.justwe.site/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>Nginx转发到go服务当中</title>
    <link href="http://blog.justwe.site/2018/11/25/go-nginx-docker/"/>
    <id>http://blog.justwe.site/2018/11/25/go-nginx-docker/</id>
    <published>2018-11-25T07:39:36.000Z</published>
    <updated>2018-11-25T07:52:38.746Z</updated>
    
    <content type="html"><![CDATA[<p>通过docker-compose编排的容器总是有一些奇怪的问题</p><a id="more"></a><p>问题核心就是go-server和nginx所属不同的容器, 需要外界能访问到go的服务就需要进行转发了</p><p>如果是在同一个容器中只需要:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  .a.com;</span><br><span class="line"></span><br><span class="line">    charset utf-8;</span><br><span class="line">    access_log  /home/a.com.access.log;</span><br><span class="line"></span><br><span class="line">    location /(css|js|fonts|img)/ &#123;</span><br><span class="line">        access_log off;</span><br><span class="line">        expires 1d;</span><br><span class="line"></span><br><span class="line">        root &quot;/path/to/app_a/static&quot;;</span><br><span class="line">        try_files $uri @backend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files /_not_exists_ @backend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location @backend &#123;</span><br><span class="line">        proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">        proxy_set_header Host            $http_host;</span><br><span class="line"></span><br><span class="line">        proxy_pass http://127.0.0.1:8080;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://beego.me/docs/deploy/nginx.md" target="_blank" rel="noopener">beego-nginx部署</a></p><p>那么如果是两个容器当中呢? 基于上面的例子, 我们需要用到<code>upstream</code>, </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">upstream go_server_proxy &#123;</span><br><span class="line">    # 这里的server 需要用到 容器名:端口 的形式</span><br><span class="line">    server go_server:9090;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    root /var/www;</span><br><span class="line">    index index.html;</span><br><span class="line"></span><br><span class="line">    charset utf-8;</span><br><span class="line">    access_log  /var/log/nginx/def.access.log;</span><br><span class="line"></span><br><span class="line">    location /(css|js|fonts|img)/ &#123;</span><br><span class="line">        access_log off;</span><br><span class="line">        expires 1d;</span><br><span class="line"></span><br><span class="line">        root &quot;/var/www/static&quot;;</span><br><span class="line">        try_files $uri @backend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files /_not_exists_ @backend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location @backend &#123;</span><br><span class="line">        proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">        proxy_set_header Host            $http_host;</span><br><span class="line">        proxy_pass  http://go_server_proxy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样做的原因是容器之间的ip并不固定, 使用容器名做host地址是更简单的选择</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;通过docker-compose编排的容器总是有一些奇怪的问题&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://blog.justwe.site/categories/go/"/>
    
    
      <category term="go" scheme="http://blog.justwe.site/tags/go/"/>
    
      <category term="docker" scheme="http://blog.justwe.site/tags/docker/"/>
    
      <category term="nginx" scheme="http://blog.justwe.site/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>Go 火焰图分析</title>
    <link href="http://blog.justwe.site/2018/11/01/go-flame-graph/"/>
    <id>http://blog.justwe.site/2018/11/01/go-flame-graph/</id>
    <published>2018-11-01T09:03:33.000Z</published>
    <updated>2018-11-25T07:38:45.761Z</updated>
    
    <content type="html"><![CDATA[<p>go version go1.11.1 darwin/amd64</p><p>安装:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ go get github.com/uber/go-torch</span><br><span class="line">$ <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/uber/go-torch</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/brendangregg/FlameGraph.git</span><br></pre></td></tr></table></figure></p><p>安装测试工具<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ go get github.com/Masterminds/glide</span><br><span class="line">$ <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/uber/go-torch</span><br><span class="line">$ glide install</span><br></pre></td></tr></table></figure></p><p>性能分析工具</p><a id="more"></a><p><code>glide install</code>如果出现  <code>Update failed for golang.org/x/sys: Cannot detect VCS</code> 这种报错, 可以执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ glide mirror <span class="built_in">set</span> https://golang.org/x/sys https://github.com/golang/sys</span><br></pre></td></tr></table></figure></p><p>改变 <code>$HOME/.gilde/mirrors.yaml</code> 的镜像链接即可</p><p>运行时完成后输入 web<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ go tool pprof --seconds 25 http://localhost:9090/debug/pprof/profile</span><br><span class="line">Fetching profile over HTTP from http://localhost:9090/debug/pprof/profile?seconds=25</span><br><span class="line">Please <span class="built_in">wait</span>... (25s)</span><br><span class="line">Saved profile <span class="keyword">in</span> /Users/gpf/pprof/pprof.samples.cpu.002.pb.gz</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Nov 2, 2018 at 11:46am (CST)</span><br><span class="line">Duration: 25s, Total samples = 2.17s ( 8.68%)</span><br><span class="line">Entering interactive mode (<span class="built_in">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) web</span><br><span class="line">Failed to execute dot. Is Graphviz installed? Error: <span class="built_in">exec</span>: <span class="string">"dot"</span>: executable file not found <span class="keyword">in</span> <span class="variable">$PATH</span></span><br></pre></td></tr></table></figure></p><p>出现 <code>Failed to execute dot. Is Graphviz installed? Error: exec: &quot;dot&quot;: executable file not found in $PATH</code> 报错, 需要安装 <code>graphviz</code>  在 mac 上就直接 <code>brew install graphviz</code> 即可</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;go version go1.11.1 darwin/amd64&lt;/p&gt;
&lt;p&gt;安装:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ go get github.com/uber/go-torch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; &lt;span class=&quot;variable&quot;&gt;$GOPATH&lt;/span&gt;/src/github.com/uber/go-torch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ git &lt;span class=&quot;built_in&quot;&gt;clone&lt;/span&gt; https://github.com/brendangregg/FlameGraph.git&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;安装测试工具&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ go get github.com/Masterminds/glide&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; &lt;span class=&quot;variable&quot;&gt;$GOPATH&lt;/span&gt;/src/github.com/uber/go-torch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ glide install&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;性能分析工具&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://blog.justwe.site/categories/go/"/>
    
    
      <category term="go" scheme="http://blog.justwe.site/tags/go/"/>
    
      <category term="flame-graph" scheme="http://blog.justwe.site/tags/flame-graph/"/>
    
  </entry>
  
  <entry>
    <title>Git-Diff</title>
    <link href="http://blog.justwe.site/2018/10/26/git-diff/"/>
    <id>http://blog.justwe.site/2018/10/26/git-diff/</id>
    <published>2018-10-26T07:01:51.000Z</published>
    <updated>2018-10-26T07:05:19.648Z</updated>
    
    <content type="html"><![CDATA[<p>git 对比文件差异</p><a id="more"></a><p>通常 <code>git diff COMMIT_ID_1 COMMIT_DI_2</code> 查看</p><p>只查看更改过的文件目录</p><p><code>git diff  --name-only COMMIT_ID_1 COMMIT_DI_2</code></p><p>快捷用法就是:</p><p><code>git diff  --name-only HEAD HEAD^</code></p><p>对比和上次提交时的改动</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;git 对比文件差异&lt;/p&gt;
    
    </summary>
    
      <category term="git" scheme="http://blog.justwe.site/categories/git/"/>
    
    
      <category term="git" scheme="http://blog.justwe.site/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>记一次 Git Revert 的经历</title>
    <link href="http://blog.justwe.site/2018/10/25/git-revert/"/>
    <id>http://blog.justwe.site/2018/10/25/git-revert/</id>
    <published>2018-10-25T08:27:06.000Z</published>
    <updated>2018-10-25T09:17:03.714Z</updated>
    
    <content type="html"><![CDATA[<p>合作开发经常会提<code>merge request</code>嘛, 然后就提了一个不该提的, 还手抖给合并了….</p><a id="more"></a><p>返现问题以后准备回退, 然后抬眼一看各分支的合并情况….<br><img src="http://blog-image.onlyoneip.com/git-merge-line.png" alt=""></p><p>哇脑壳痛, 这就用不了平时最喜欢的 <code>reset</code> 了, 查了查资料, 想<strong>取消某一次 merge request</strong>用 <code>revert</code> 是最合适的</p><p>接下来分三步,先找到要回退的那次 mr, 通常是这样的:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> </span><br><span class="line"></span><br><span class="line">commit 365ea982c24f2c60150df6159734ab73b74515bc (origin/master, origin/HEAD)</span><br><span class="line">Merge: 465fbfb8 f15b39ae</span><br><span class="line">Author: xxx &lt;xxx&gt;</span><br><span class="line">Date:   Thu Oct 25 15:41:10 2018 +0800</span><br><span class="line"></span><br><span class="line">    Merge branch <span class="string">'master'</span> of xxxxxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line">commit 465fbfb8084089f9d08516b4d75ba51ae5dcd5ce</span><br><span class="line">Author: xxx &lt;xxx&gt;</span><br><span class="line">Date:   Thu Oct 25 15:41:03 2018 +0800</span><br><span class="line"></span><br><span class="line">    merge</span><br><span class="line"></span><br><span class="line">commit 1e309ff40fd02d1c9c6e604c2649d8a94086a573</span><br><span class="line">Author: xxx &lt;zhangkaixuan&gt;</span><br><span class="line">Date:   Thu Oct 25 15:40:37 2018 +0800</span><br><span class="line"></span><br><span class="line">    merge</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>这样的, 这只是 log 的中间的一部分, 假设 mr 之后后续又有很多 mr 已经合并了, 那么先找到我们要回退的 <code>commit id</code>, 这里就假设一个叫 <code>c76627674dedf4fc067cb0c5b2afbc123fd9c053</code></p><ol><li><p>执行 <code>git revert -m 1 c76627674dedf4fc067cb0c5b2afbc123fd9c053</code></p><p> 通常执行这一步之后没什么冲突就可以了, 然后有冲突了, 就和正常的 merger conflicts 处理一样</p></li><li><p>解决完冲突, 执行 <code>git revert --continue</code> 这就算合并了</p><p> 那么回滚到一半不想做了, 也好说, 执行 <code>git revert --abort</code> 以后, 大家就当无事发生过</p></li></ol><p>关于 <code>git revert -m 1</code> 这个<code>1</code>指的是 <code>mainline</code>, 1 代表着 master 这条线<br><a href="https://stackoverflow.com/a/5971033/9561528" target="_blank" rel="noopener">资料参考: Why does git revert complain about a missing -m option?</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;合作开发经常会提&lt;code&gt;merge request&lt;/code&gt;嘛, 然后就提了一个不该提的, 还手抖给合并了….&lt;/p&gt;
    
    </summary>
    
      <category term="git" scheme="http://blog.justwe.site/categories/git/"/>
    
    
      <category term="git" scheme="http://blog.justwe.site/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>转 Vscode 设置终端字体</title>
    <link href="http://blog.justwe.site/2018/10/16/vscode-terminal-font-macOS/"/>
    <id>http://blog.justwe.site/2018/10/16/vscode-terminal-font-macOS/</id>
    <published>2018-10-16T07:50:28.000Z</published>
    <updated>2018-10-16T07:59:17.477Z</updated>
    
    <content type="html"><![CDATA[<p>mac 上设置vscode终端样式(尤其是想用 powershell 主题的)</p><a id="more"></a><h3 id="Mac下配置vscode终端字体："><a href="#Mac下配置vscode终端字体：" class="headerlink" title="Mac下配置vscode终端字体："></a>Mac下配置vscode终端字体：</h3><p>在Mac 10.13.6下的解决方案（亲测可用），其他版本做参考。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下载安装字体</span><br><span class="line"><span class="variable">$cd</span> /Library/Fonts</span><br><span class="line"><span class="variable">$sudo</span> git <span class="built_in">clone</span> https://github.com/abertsch/Menlo-for-Powerline.git</span><br></pre></td></tr></table></figure><p>config.json 位置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Windows %APPDATA%\Code\User\settings.json</span><br><span class="line">Mac <span class="variable">$HOME</span>/Library/Application Support/Code/User/settings.json</span><br><span class="line">Linux <span class="variable">$HOME</span>/.config/Code/User/settings.json</span><br></pre></td></tr></table></figure></p><p>在 vscode 配置中设置字体：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$HOME</span>/Library/Application Support/Code/User/settings.json</span><br><span class="line"><span class="comment"># 文件内指定字体主题</span></span><br><span class="line"><span class="string">"terminal.integrated.fontFamily"</span>: <span class="string">"Menlo for Powerline"</span></span><br></pre></td></tr></table></figure></p><h3 id="在Ubuntu-18-04-1LTS-下的解决方案（亲测可用），其他版本linux做参考。"><a href="#在Ubuntu-18-04-1LTS-下的解决方案（亲测可用），其他版本linux做参考。" class="headerlink" title="在Ubuntu 18.04.1LTS 下的解决方案（亲测可用），其他版本linux做参考。"></a>在Ubuntu 18.04.1LTS 下的解决方案（亲测可用），其他版本linux做参考。</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">下载安装字体</span><br><span class="line"><span class="variable">$cd</span> /usr/share/fonts/truetype/</span><br><span class="line"><span class="variable">$sudo</span> git <span class="built_in">clone</span> https://github.com/abertsch/Menlo-for-Powerline.git</span><br><span class="line">刷新字体</span><br><span class="line"><span class="variable">$sudo</span> <span class="built_in">fc</span>-cache -f -v</span><br></pre></td></tr></table></figure><p>回到  Vs Code的用户设置.json  中加入以下代码<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"terminal.integrated.fontFamily": "Menlo for Powerline",</span><br></pre></td></tr></table></figure></p><p><a href="https://blog.csdn.net/chenghai37/article/details/81417293" target="_blank" rel="noopener">文章来源</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;mac 上设置vscode终端样式(尤其是想用 powershell 主题的)&lt;/p&gt;
    
    </summary>
    
      <category term="tools" scheme="http://blog.justwe.site/categories/tools/"/>
    
    
      <category term="tools" scheme="http://blog.justwe.site/tags/tools/"/>
    
  </entry>
  
  <entry>
    <title>Golang 处理 Map[interface{}]interface{} 数据</title>
    <link href="http://blog.justwe.site/2018/09/28/go-complex-interface/"/>
    <id>http://blog.justwe.site/2018/09/28/go-complex-interface/</id>
    <published>2018-09-28T08:58:31.000Z</published>
    <updated>2018-09-28T09:04:31.468Z</updated>
    
    <content type="html"><![CDATA[<p>go 调用 rpc , 掉用其他的服务时会出现一些神奇的数据结构, 今天我们来实验一个</p><a id="more"></a><p>上代码:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"encoding/json"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里是针对出现 map[interface&#123;&#125;]interface&#123;&#125; 类型数据进行的一次转化处理示例</span></span><br><span class="line"><span class="keyword">type</span> respBody <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟一个从 hprose-php-server 传过来的数据</span></span><br><span class="line">res := <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">"errorCode"</span>: <span class="number">200</span>,</span><br><span class="line"><span class="string">"errorMsg"</span>:  <span class="string">"登录成功"</span>,</span><br><span class="line"><span class="string">"responseData"</span>: <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">"hx_password"</span>: <span class="string">"c427ee88c8abeeee4fcddbfbf8767025"</span>,</span><br><span class="line"><span class="string">"like_post"</span>:   <span class="number">0</span>,</span><br><span class="line"><span class="string">"avatar"</span>:      <span class="string">"http://img2.xxx.com/user/3_100_100.png"</span>,</span><br><span class="line"><span class="string">"beauty_list"</span>: []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;,</span><br><span class="line"><span class="string">"role"</span>:        []<span class="keyword">string</span>&#123;<span class="string">"admin"</span>, <span class="string">"emplyee"</span>, <span class="string">"boss"</span>&#125;,</span><br><span class="line"><span class="string">"mission_status"</span>: <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">"ok"</span>: <span class="number">233</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tmp := respHandler(res)</span><br><span class="line">log.Println(<span class="string">"tmp:"</span>, tmp)</span><br><span class="line"></span><br><span class="line">by, err := json.Marshal(tmp)</span><br><span class="line">log.Println(<span class="string">"output json:"</span>, <span class="keyword">string</span>(by), err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">respHandler</span><span class="params">(res <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(tmp <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line"><span class="comment">// map 需要初始化一个出来</span></span><br><span class="line">tmp = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">log.Println(<span class="string">"input res is : "</span>, res)</span><br><span class="line"><span class="keyword">switch</span> res.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="literal">nil</span>:</span><br><span class="line"><span class="keyword">return</span> tmp</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;:</span><br><span class="line"><span class="keyword">return</span> res.(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]<span class="keyword">interface</span>&#123;&#125;:</span><br><span class="line">log.Println(<span class="string">"map[interface&#123;&#125;]interface&#123;&#125; res:"</span>, res)</span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> res.(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">log.Println(<span class="string">"loop:"</span>, k, v)</span><br><span class="line"><span class="keyword">switch</span> k.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">string</span>:</span><br><span class="line"><span class="keyword">switch</span> v.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]<span class="keyword">interface</span>&#123;&#125;:</span><br><span class="line">log.Println(<span class="string">"map[interface&#123;&#125;]interface&#123;&#125; v:"</span>, v)</span><br><span class="line">tmp[k.(<span class="keyword">string</span>)] = respHandler(v)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">log.Printf(<span class="string">"default v: %v %v \n"</span>, k, v)</span><br><span class="line">tmp[k.(<span class="keyword">string</span>)] = v</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> tmp</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="comment">// 暂时没遇到更复杂的数据</span></span><br><span class="line">log.Println(<span class="string">"unknow data:"</span>, res)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> tmp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;go 调用 rpc , 掉用其他的服务时会出现一些神奇的数据结构, 今天我们来实验一个&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://blog.justwe.site/categories/go/"/>
    
    
      <category term="go" scheme="http://blog.justwe.site/tags/go/"/>
    
      <category term="switch" scheme="http://blog.justwe.site/tags/switch/"/>
    
      <category term="json" scheme="http://blog.justwe.site/tags/json/"/>
    
  </entry>
  
  <entry>
    <title>Go 开发时的一些初级问题</title>
    <link href="http://blog.justwe.site/2018/09/25/go-primary-mistakes/"/>
    <id>http://blog.justwe.site/2018/09/25/go-primary-mistakes/</id>
    <published>2018-09-25T02:57:02.000Z</published>
    <updated>2018-09-28T09:03:32.263Z</updated>
    
    <content type="html"><![CDATA[<p>平时碰到的一些小问题, 记一下</p><a id="more"></a><h4 id="assignment-to-entry-in-nil-map-map-赋值问题"><a href="#assignment-to-entry-in-nil-map-map-赋值问题" class="headerlink" title="assignment to entry in nil map, map 赋值问题"></a>assignment to entry in nil map, map 赋值问题</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// ServiceMap 可用服务列表</span></span><br><span class="line"><span class="keyword">type</span> ServiceMap <span class="keyword">struct</span> &#123;</span><br><span class="line">handlers <span class="keyword">map</span>[<span class="keyword">string</span>]BaseClient</span><br><span class="line">RWLock   sync.RWMutex</span><br><span class="line">BaseService</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ServiceMp *ServiceMap</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #1</span></span><br><span class="line">    ServiceMp = &amp;ServiceMap&#123;&#125;</span><br><span class="line">    <span class="comment">// #2.1</span></span><br><span class="line">ServiceMp.handlers = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]BaseClient)</span><br><span class="line"></span><br><span class="line">ServiceMp.AddMethod(<span class="string">"XyToken"</span>, BaseClient&#123;</span><br><span class="line">Module: <span class="string">"System"</span>,</span><br><span class="line">Class:  <span class="string">"XyToken"</span>,</span><br><span class="line">Func:   <span class="string">"getXyOpenKey"</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">log.Println(<span class="string">"get method:"</span>, ServiceMp.handlers)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddMethod 添加方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(serv *ServiceMap)</span> <span class="title">AddMethod</span><span class="params">(key <span class="keyword">string</span>, body BaseClient)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"AddMethod error:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, ok := serv.handlers[key]; !ok &#123;</span><br><span class="line">        serv.RWLock.Lock()</span><br><span class="line">        <span class="comment">// #2.2</span></span><br><span class="line">serv.handlers[key] = body</span><br><span class="line">serv.RWLock.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>#1</code> 当文件里有一个全局的变量时, 需要先初始化 <code>ServiceMp = &amp;ServiceMap{}</code> 一个实体出来 </li><li><code>#2</code> 在 <code>ServiceMap.handlers</code>这个值添加方法的时候, 不能直接 <code>serv.handlers[key] = body</code>, 而是要先给它赋值一个空的切片,才能往里面加东西, 参考 <code>#2.1 和 #2.2</code></li></ul><h4 id="interface-conversion-interface-is-float64-not-int"><a href="#interface-conversion-interface-is-float64-not-int" class="headerlink" title="interface conversion: interface {} is float64, not int"></a>interface conversion: interface {} is float64, not int</h4><p>通常json 转成 <code>map[string]interface{}</code> 时,数字类型就是<code>float64</code>的, </p><p>比如:想把它转成<code>int</code>类型使用就要<code>auth.Sys = int(sys.(float64))</code>这样(sys 就是一个 interface{} 类型的数字), 而不是<code>auth.Sys = sys.(int)</code>, 后一种写法会有 painc 错误</p><h4 id="xxx-type-只能用在-switch-当中-不想这么写就用-reflect-Typeof-xxx"><a href="#xxx-type-只能用在-switch-当中-不想这么写就用-reflect-Typeof-xxx" class="headerlink" title="xxx.(type) 只能用在 switch 当中, 不想这么写就用 reflect.Typeof(xxx)"></a>xxx.(type) 只能用在 switch 当中, 不想这么写就用 reflect.Typeof(xxx)</h4>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;平时碰到的一些小问题, 记一下&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://blog.justwe.site/categories/go/"/>
    
    
      <category term="go" scheme="http://blog.justwe.site/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>Golang 的测试文件</title>
    <link href="http://blog.justwe.site/2018/09/20/go-test/"/>
    <id>http://blog.justwe.site/2018/09/20/go-test/</id>
    <published>2018-09-20T02:45:51.000Z</published>
    <updated>2018-09-20T02:55:06.095Z</updated>
    
    <content type="html"><![CDATA[<p>一些函数没有连续的会话状态是可以写出来顺便就写一个测试脚本了<br><a id="more"></a><br>比如:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// redis.go</span></span><br><span class="line"><span class="keyword">package</span> tools</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"github.com/gomodule/redigo/redis"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line"><span class="string">"user-server/config"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">redisClient  *redis.Pool</span><br><span class="line">REDIS_HOST   <span class="keyword">string</span></span><br><span class="line">REDIS_DB     <span class="keyword">int</span></span><br><span class="line">REDIS_AUTH   <span class="keyword">string</span></span><br><span class="line">MAX_ACTIVE   <span class="keyword">int</span></span><br><span class="line">MAX_IDLE     <span class="keyword">int</span></span><br><span class="line">IDLE_TIMEOUT <span class="keyword">int64</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">REDIS_HOST = config.Conf.Redis.Host</span><br><span class="line">REDIS_DB = <span class="number">0</span></span><br><span class="line">REDIS_AUTH = <span class="string">"abc"</span></span><br><span class="line">MAX_ACTIVE = <span class="number">10</span></span><br><span class="line">MAX_IDLE = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*@MaxIdle 最大空闲链接</span></span><br><span class="line"><span class="comment">*@MaxActive 最大活跃链接</span></span><br><span class="line"><span class="comment">*@IdleTimeout 自动超时时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">redisClient = &amp;redis.Pool&#123;</span><br><span class="line">MaxIdle:     MAX_IDLE,</span><br><span class="line">MaxActive:   MAX_ACTIVE,</span><br><span class="line">IdleTimeout: <span class="number">30</span> * time.Second,</span><br><span class="line">Dial: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(redis.Conn, error)</span></span> &#123;</span><br><span class="line">c, err := redis.Dial(<span class="string">"tcp"</span>, REDIS_HOST)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> REDIS_AUTH != <span class="string">""</span> &#123;</span><br><span class="line">c.Do(<span class="string">"AUTH"</span>, REDIS_AUTH)</span><br><span class="line">&#125;</span><br><span class="line">c.Do(<span class="string">"SELECT"</span>, REDIS_DB)</span><br><span class="line"><span class="keyword">return</span> c, <span class="literal">nil</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetRedis</span><span class="params">()</span> <span class="title">redis</span>.<span class="title">Conn</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> redisClient.Get()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的测试文件 在同目录创建一个 <code>redis_test.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> tools</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"testing"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGetRedis</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">co := GetRedis()</span><br><span class="line"><span class="keyword">defer</span> co.Close()</span><br><span class="line"></span><br><span class="line">co.Do(<span class="string">"SET"</span>, <span class="string">"test_redis_key"</span>, <span class="string">"test_redis_value"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试脚本的标准格式是:</p><ul><li>文件名为 <code>xxx_test.go</code> 作为测试文件标记</li><li>引入 <code>testing</code> 包</li><li>要测试的函数名为 <code>TestXXXX(t *testing.T)</code> 输出结果通过  <code>t.Logf()</code> <code>t.Error()</code> 这类的测试包提供的函数来调用</li></ul><p>写完代码, 在目录下运行:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行当前目录所有测试文件并输出结果</span></span><br><span class="line">go <span class="built_in">test</span> -v</span><br><span class="line"><span class="comment"># 运行指定测试文件, 需要把被测试文件也带上</span></span><br><span class="line">go <span class="built_in">test</span> -v redis.go redis_test.go</span><br><span class="line"><span class="comment"># 运行指定的测试方法</span></span><br><span class="line">go <span class="built_in">test</span> -v --test.run TestGetRedis</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;一些函数没有连续的会话状态是可以写出来顺便就写一个测试脚本了&lt;br&gt;
    
    </summary>
    
      <category term="go" scheme="http://blog.justwe.site/categories/go/"/>
    
    
      <category term="go" scheme="http://blog.justwe.site/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>Go Interface 的机制</title>
    <link href="http://blog.justwe.site/2018/09/12/go-interface-tip/"/>
    <id>http://blog.justwe.site/2018/09/12/go-interface-tip/</id>
    <published>2018-09-12T06:53:03.000Z</published>
    <updated>2018-09-12T07:07:37.407Z</updated>
    
    <content type="html"><![CDATA[<p>对 interface 赋值变量的时候经常出的问题</p><a id="more"></a><p>日常开发时有个这样的例子:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Human <span class="keyword">interface</span> &#123;</span><br><span class="line">Run()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Boy <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Boy)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"my name is "</span> + b.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">xiaoming := Boy&#123;Name: <span class="string">"xiao ming"</span>&#125;</span><br><span class="line"><span class="keyword">var</span> h Human</span><br><span class="line"><span class="comment">// h = xiaoming // #1 会报错, Boy does not implement Human (Run method has pointer receiver)</span></span><br><span class="line">h = &amp;xiaoming</span><br><span class="line">h.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果用 <code>#1</code> 这行代码时会出现以下错误:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># command-line-arguments</span></span><br><span class="line">./main.go:23:4: cannot use xiaoming (<span class="built_in">type</span> Boy) as <span class="built_in">type</span> Human <span class="keyword">in</span> assignment:</span><br><span class="line">        Boy does not implement Human (Run method has pointer receiver)</span><br></pre></td></tr></table></figure></p><p>然而用下面的 <code>h = &amp;xiaoming</code> 是正常的</p><p>这个问题，首先得先了解一下Golang 中 方法的集合的概念，一个struct虽然可以通过值类型和引用类型两种方式定义方法，但是不通的对象类型对应了不同的方法集：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Values                    Methods Receivers</span><br><span class="line">-----------------------------------------------</span><br><span class="line"> T                        (t T)</span><br><span class="line">*T                        (t T) and (t *T)</span><br></pre></td></tr></table></figure><p>值类型的对象只有（t T) 结构的方法，虽然值类型的对象也可以调用(t *T) 方法，但这实际上是Golang编译器自动转化成了&amp;t的形式来调用方法，并不是表明值类型的对象拥有该方法。</p><p>换一个维度来看上面的表格可能更加直观：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Methods Receivers         Values</span><br><span class="line">-----------------------------------------------</span><br><span class="line">(t T)                     T and *T</span><br><span class="line"></span><br><span class="line">(t *T)                    *T</span><br></pre></td></tr></table></figure><p>这就意味着指针类型的receiver 方法实现接口时，只有指针类型的对象实现了该接口。</p><p>对应上面的例子来说，只有&amp;user实现了notifier接口，而user根本没有实现该接口。所以上面代码会报出这样的异常。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;对 interface 赋值变量的时候经常出的问题&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://blog.justwe.site/categories/go/"/>
    
    
      <category term="go" scheme="http://blog.justwe.site/tags/go/"/>
    
      <category term="interface" scheme="http://blog.justwe.site/tags/interface/"/>
    
  </entry>
  
  <entry>
    <title>身为 Phper 为什么我选择 Go 语言?</title>
    <link href="http://blog.justwe.site/2018/09/12/go-why/"/>
    <id>http://blog.justwe.site/2018/09/12/go-why/</id>
    <published>2018-09-12T06:45:50.000Z</published>
    <updated>2018-12-28T06:27:46.572Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>想换个语言开发的同学可以看这里</p></blockquote><a id="more"></a><h2 id="概况"><a href="#概况" class="headerlink" title="概况"></a>概况</h2><h3 id="go-相比-php-有哪些优势"><a href="#go-相比-php-有哪些优势" class="headerlink" title="go 相比 php 有哪些优势?"></a>go 相比 php 有哪些优势?</h3><ul><li>go 的部署简单, 运行时只要把一个二进制文件扔到机器上就行, 这一点在容器化方面优势很大</li><li>可控的多线程和更简单的多线程间通信</li><li>编译型语言对动态语言天生的性能优势, 变量在开发过程中不会突然从 str 变成 array</li><li>微服务相关的项目多</li><li>自 go 1.5 以后, 底层完全采用的 go 自己的代码重构</li></ul><h3 id="go-本身的优势"><a href="#go-本身的优势" class="headerlink" title="go 本身的优势"></a>go 本身的优势</h3><ul><li>开发效率和运行的效率都在可接受范围</li><li>成熟的官方库和活跃的社区, 还有官方出品的工具链</li><li>语法简单(25个关键字), 对于初学者来说不用受配置环境的苦</li><li>良好兼容 c 语言</li><li>语言层面支持并发</li><li>运行时对外部的依赖极少</li></ul><h3 id="go-较于-php-的劣势"><a href="#go-较于-php-的劣势" class="headerlink" title="go 较于 php 的劣势"></a>go 较于 php 的劣势</h3><ul><li>编译造成的繁琐操作</li><li>代码量偏多</li><li>至今没有一个成熟的依赖库管理工具, 缺乏版本管理</li><li>字典类型要考虑并发读写安全的问题, 需要有<code>锁</code>的概念, 这一点 swoole 也有类似的情况</li></ul><hr><h2 id="go-的特色"><a href="#go-的特色" class="headerlink" title="go 的特色"></a>go 的特色</h2><h3 id="defer-延迟处理"><a href="#defer-延迟处理" class="headerlink" title="defer 延迟处理"></a>defer 延迟处理</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">OpenFile</span><span class="params">()</span> <span class="title">bool</span></span>&#123;</span><br><span class="line">  file.Open(<span class="string">"file/path"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> condition1 &#123;</span><br><span class="line">    file.Close()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> condition2 &#123;</span><br><span class="line">    file.Close()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  file.Close()</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对比一下<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">OpenFile</span><span class="params">()</span> <span class="title">bool</span></span>&#123;</span><br><span class="line">  file.Open(<span class="string">"file/path"</span>)</span><br><span class="line">  <span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> condition1 &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> condition2 &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span> <span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i :=<span class="number">0</span>;i &lt; <span class="number">5</span> ; i++&#123;</span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"输出："</span>,i)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 输出： 4</span></span><br><span class="line"><span class="comment">// 输出： 3</span></span><br><span class="line"><span class="comment">// 输出： 2</span></span><br><span class="line"><span class="comment">// 输出： 1</span></span><br><span class="line"><span class="comment">// 输出： 0</span></span><br></pre></td></tr></table></figure><h3 id="多返回值"><a href="#多返回值" class="headerlink" title="多返回值"></a>多返回值</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">multipartReturn</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="params">(res <span class="keyword">int</span>, err error)</span></span> &#123;</span><br><span class="line">res = a + b</span><br><span class="line"><span class="keyword">if</span> res &gt; <span class="number">3</span> &#123;</span><br><span class="line"><span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"math: square root of negative number"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="goroutinue-并发"><a href="#goroutinue-并发" class="headerlink" title="goroutinue 并发"></a>goroutinue 并发</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">syncChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">go</span> loop(<span class="literal">true</span>, syncChan)</span><br><span class="line">loop(<span class="literal">false</span>, syncChan)</span><br><span class="line">&lt;-syncChan</span><br><span class="line">fmt.Println(<span class="string">"done"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loop</span><span class="params">(desc <span class="keyword">bool</span>, syncChan <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> desc &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">10</span>; i &gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line">fmt.Printf(<span class="string">"loop1: %d \n"</span>, i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这个防止子线程提前退出</span></span><br><span class="line">syncChan &lt;- <span class="number">1</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">10</span>; j++ &#123;</span><br><span class="line">fmt.Printf(<span class="string">"loop2: %d \n"</span>, j)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="channel-多线程通信"><a href="#channel-多线程通信" class="headerlink" title="channel 多线程通信"></a>channel 多线程通信</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 创建一个缓冲</span></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">go</span> loopPro(<span class="literal">true</span>, ch)</span><br><span class="line"><span class="keyword">go</span> loopPro(<span class="literal">false</span>, ch)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">20</span>; i++ &#123;</span><br><span class="line">fmt.Print(&lt;-ch)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加入 channel 的概念</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loopPro</span><span class="params">(desc <span class="keyword">bool</span>, ch <span class="keyword">chan</span>&lt;- <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> desc &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">10</span>; i &gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line">time.Sleep(time.Second)</span><br><span class="line">ch &lt;- fmt.Sprintf(<span class="string">"loop1: %d \n"</span>, i)</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">10</span>; j++ &#123;</span><br><span class="line">time.Sleep(time.Second)</span><br><span class="line">ch &lt;- fmt.Sprintf(<span class="string">"loop2: %d \n"</span>, j)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="跨平台"><a href="#跨平台" class="headerlink" title="跨平台"></a>跨平台</h3><p><code>http-server</code>的 demo<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"route: http://localhost:9090/"</span>)</span><br><span class="line">fmt.Println(<span class="string">"route: http://localhost:9090/hello"</span>)</span><br><span class="line"></span><br><span class="line">mux := http.NewServeMux()</span><br><span class="line"></span><br><span class="line">mux.HandleFunc(<span class="string">"/hello"</span>, helloHandler)</span><br><span class="line">mux.HandleFunc(<span class="string">"/"</span>, pageHandler)</span><br><span class="line"></span><br><span class="line">http.ListenAndServe(<span class="string">":9090"</span>, mux)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">helloHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">w.Write([]<span class="keyword">byte</span>(<span class="string">"hello world"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pageHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">w.Write([]<span class="keyword">byte</span>(<span class="string">"hi baby"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可根编译成指定平台的执行文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build main.go</span><br><span class="line">CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build main.go</span><br></pre></td></tr></table></figure></p><h3 id="调用-c-代码"><a href="#调用-c-代码" class="headerlink" title="调用 c 代码"></a>调用 c 代码</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 下面是 C 代码 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// int add(int a, int b) &#123;</span></span><br><span class="line"><span class="comment">//     return a + b;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"C"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := C.<span class="keyword">int</span>(<span class="number">1</span>)</span><br><span class="line">b := C.<span class="keyword">int</span>(<span class="number">2</span>)</span><br><span class="line">value := C.add(a, b)</span><br><span class="line">fmt.Printf(<span class="string">"%v\n"</span>, value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="http://bastengao.com/blog/2017/12/go-cgo-c.html" target="_blank" rel="noopener">代码来源</a></p><hr><h2 id="大体了解一下语法"><a href="#大体了解一下语法" class="headerlink" title="大体了解一下语法"></a>大体了解一下语法</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>官网安装包地址: <a href="https://golang.org/dl/" target="_blank" rel="noopener">https://golang.org/dl/</a><br>以 centos 为例<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://dl.google.com/go/go1.11.linux-amd64.tar.gz</span><br><span class="line">$ tar -C /usr/<span class="built_in">local</span> -zxvf go1.11.linux-amd64.tar.gz</span><br><span class="line">$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/go/bin/</span><br><span class="line">$ go</span><br></pre></td></tr></table></figure></p><p>GOROOT 不用管它…<br>GOPATH 目录结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/                                # 生成的执行文件                </span><br><span class="line">pkg/                                # 编译时用到的外部库执行文件</span><br><span class="line">src/                                # 我们开发的各种库和 go get 到的各种库源码</span><br></pre></td></tr></table></figure></p><h3 id="Hello-world"><a href="#Hello-world" class="headerlink" title="Hello world"></a>Hello world</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"hello world"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行 <code>go run main.go</code></p><h3 id="资源类型"><a href="#资源类型" class="headerlink" title="资源类型"></a>资源类型</h3><p>常用: </p><ul><li><code>int/int8/int16/int32/int64</code></li><li><code>uint/uint8/uint16/uint32/uint64</code></li><li><code>float32/float64</code></li><li><code>string</code></li><li><code>array</code></li><li><code>slice</code>(切片)</li><li><code>map</code>(字典)</li><li><code>point</code>(指针)</li></ul><p>面向对象: </p><ul><li><code>struct</code></li><li><code>interface</code></li></ul><p>特色: </p><ul><li><code>chan</code></li></ul><h3 id="变量赋值"><a href="#变量赋值" class="headerlink" title="变量赋值"></a>变量赋值</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="keyword">int</span></span><br><span class="line">a = <span class="number">1</span></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">a := <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数组</span></span><br><span class="line"><span class="keyword">var</span> arr [<span class="number">10</span>]<span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 切片</span></span><br><span class="line"><span class="keyword">var</span> slice1 []<span class="keyword">int</span> = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">var</span> slice1 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">3</span>, <span class="number">10</span>)    <span class="comment">// 预留了10字节内存</span></span><br><span class="line">slice1 = []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">slice2 := slice1[<span class="number">2</span>:]<span class="comment">// [3]</span></span><br><span class="line"><span class="keyword">var</span> any <span class="keyword">interface</span>&#123;&#125;         <span class="comment">// 空接口接一切</span></span><br><span class="line">any = slice2<span class="comment">// [3]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 字典</span></span><br><span class="line"><span class="keyword">var</span> mp <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">mp[<span class="string">"a"</span>] = <span class="string">"诶"</span></span><br><span class="line">mp[<span class="string">"b"</span>] = <span class="string">"必"</span></span><br><span class="line"><span class="comment">// 同上 </span></span><br><span class="line">mp := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"a"</span>: <span class="string">"aaa"</span>, <span class="string">"b"</span>: <span class="string">"bbb"</span>&#125;</span><br><span class="line"><span class="comment">// 这样写得清楚这是干什么的</span></span><br><span class="line"><span class="keyword">var</span> mp <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="逻辑处理"><a href="#逻辑处理" class="headerlink" title="逻辑处理"></a>逻辑处理</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>;i &lt; <span class="number">5</span> ; i++ &#123;</span><br><span class="line">    fmt.Println(<span class="string">"输出："</span>,i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> i &gt; <span class="number">1</span> &#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 隐式执行 break</span></span><br><span class="line"><span class="keyword">switch</span> os := runtime.GOOS; os &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"darwin"</span>:</span><br><span class="line">fmt.Println(<span class="string">"OS X."</span>)</span><br><span class="line"><span class="keyword">case</span> <span class="string">"linux"</span>:</span><br><span class="line">fmt.Println(<span class="string">"Linux."</span>)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Printf(<span class="string">"%s."</span>, os)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h3><h4 id="struct"><a href="#struct" class="headerlink" title="struct"></a>struct</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> human <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="keyword">string</span></span><br><span class="line">Age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 隐式的继承 human 的属性</span></span><br><span class="line"><span class="keyword">type</span> ming <span class="keyword">struct</span> &#123;</span><br><span class="line">human</span><br><span class="line">Skill <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加结构体所属的方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h human)</span> <span class="title">Say</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"我叫%s,今年%d"</span>, h.Name, h.Age)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> xm ming</span><br><span class="line">xm.Name = <span class="string">"小明"</span></span><br><span class="line">xm.Age = <span class="number">18</span></span><br><span class="line">xm.Skill = <span class="string">"跑得快"</span></span><br><span class="line">fmt.Println(xm)</span><br><span class="line"></span><br><span class="line">xm.Say()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="interface"><a href="#interface" class="headerlink" title="interface"></a>interface</h4><blockquote><p>当看到一只鸟走起来像鸭子、游泳起来像鸭子、叫起来也像鸭子，那么这只鸟就可以被称为鸭子。 – <a href="https://zh.wikipedia.org/wiki/%E9%B8%AD%E5%AD%90%E7%B1%BB%E5%9E%8B" target="_blank" rel="noopener">鸭子类型</a></p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Animal <span class="keyword">interface</span> &#123;</span><br><span class="line">Speak() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Dog <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d Dog)</span> <span class="title">Speak</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"Woof!"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Cat <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Cat)</span> <span class="title">Speak</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"Meow!"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PHPProgrammer <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p PHPProgrammer)</span> <span class="title">Speak</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"PHP is the best language! "</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PassBy <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">animals := []Animal&#123;Dog&#123;&#125;, Cat&#123;&#125;, PHPProgrammer&#123;&#125;&#125;</span><br><span class="line"><span class="comment">// animals[3] = PassBy&#123;&#125;// 编译不会通过, 因为没有实现 Animal 接口</span></span><br><span class="line"><span class="keyword">for</span> _, animal := <span class="keyword">range</span> animals &#123;</span><br><span class="line">fmt.Println(animal.Speak())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/gaopengfei123123/why-go" target="_blank" rel="noopener">demo 代码地址</a></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;想换个语言开发的同学可以看这里&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="go" scheme="http://blog.justwe.site/categories/go/"/>
    
    
      <category term="go" scheme="http://blog.justwe.site/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>Php开发过程中不常碰到的error (8.14更新)</title>
    <link href="http://blog.justwe.site/2018/08/26/php-unsual-mistakes/"/>
    <id>http://blog.justwe.site/2018/08/26/php-unsual-mistakes/</id>
    <published>2018-08-26T02:30:23.000Z</published>
    <updated>2019-01-23T10:50:05.949Z</updated>
    
    <content type="html"><![CDATA[<p>这里做一些备注,以防再次碰到<br><a id="more"></a></p><h3 id="url-当中的参数有-amp-timestamp-1234567890这样的字段会被转义成xtamp-1234567890"><a href="#url-当中的参数有-amp-timestamp-1234567890这样的字段会被转义成xtamp-1234567890" class="headerlink" title="url 当中的参数有 &amp;timestamp=1234567890这样的字段会被转义成xtamp=1234567890"></a>url 当中的参数有 <code>&amp;timestamp=1234567890</code>这样的字段会被转义成<code>xtamp=1234567890</code></h3><p>这个不仅存在于页面解析当中,当使用 curl 请求时拼接的参数有这种格式的也会发生转义<br>解决方法有两个:</p><ol><li>把 timestamp 这个参数放在 urlQuery 的最前面, <code>?timestamp=1234567890</code> 这样避免出现 <code>&amp;time</code>发生转义的情况</li><li>将<code>&amp;</code>用<code>&amp;amp;</code>来代替</li></ol><h3 id="Automatically-populating-HTTP-RAW-POST-DATA-is-deprecated-and-will-be-removed-in-a-future-version"><a href="#Automatically-populating-HTTP-RAW-POST-DATA-is-deprecated-and-will-be-removed-in-a-future-version" class="headerlink" title="Automatically populating $HTTP_RAW_POST_DATA is deprecated and will be removed in a future version."></a>Automatically populating $HTTP_RAW_POST_DATA is deprecated and will be removed in a future version.</h3><p>出现这句话通常说明你在用的 php 版本是5.6.而且在<code>php&lt;=5.6</code>的时候,进行 <code>application/json</code>格式的 post 提交会把数据放在<code>$HTTP_RAW_POST_DATA</code>这个系统变量里面,在<code>php&gt;=7</code>的时候这个变量被移除了,统统归总到<code>php://input</code>这里<br>解决方法:</p><ol><li><p>根据系统提示的走:</p><blockquote><p>Although that indeed would be technically impossible (as $HTTP_RAW_POST_DATA is populated in the bootstrapping phase of the PHP process) allow one to override the setting by means of calling ini_set.</p></blockquote><p> 要确保自己的系统中没有使用 <code>HTTP_RAW_POST_DATA</code>这个变量,直接在<code>php.ini</code>里面禁掉它的设置,但是容易出现系统中又打开的情况(在框架中很常见)</p></li><li>改一下自己的提交方式, 使用 <code>application/form-data</code>或者<code>application/x-www-form-urlencoded</code>这种格式的提交, 然后在后端接收数据的时候再转成自己需要的格式(通常是数组)<br> <a href="https://www.bram.us/2014/10/26/php-5-6-automatically-populating-http_raw_post_data-is-deprecated-and-will-be-removed-in-a-future-version/" target="_blank" rel="noopener">参考资料</a></li></ol><h3 id="Exception-‘yii-db-Exception’-with-message-‘SQLSTATE-HY000-2002-No-such-file-or-directory’"><a href="#Exception-‘yii-db-Exception’-with-message-‘SQLSTATE-HY000-2002-No-such-file-or-directory’" class="headerlink" title="Exception ‘yii\db\Exception’ with message ‘SQLSTATE[HY000] [2002] No such file or directory’"></a>Exception ‘yii\db\Exception’ with message ‘SQLSTATE[HY000] [2002] No such file or directory’</h3><p>这种情况出现在平时运行的好好的, 但是突然换 cli 模式后这个配置就出问题了,原因在当 <code>host=localhost</code>时走的是 unix:socket 链接, 当<code>host=127.0.0.1</code>走的是 tcp 链接,这在<code>php-fpm</code>和<code>php-cli</code>中有点区别,尤其是本地没有安装 mysql 的时候<br>解决方法有三种:</p><ol><li>将本地链接配置统一成 <code>127.0.0.1</code></li><li>查看 MySQL 中的<code>user</code>表, <code>host=localhost</code>和<code>host=127.0.0.1</code>是不是用的同一个账号密码</li><li>配置<code>php.ini</code>文件中的<code>pdo_mysql.default_socket=</code> 写上完整的 socket 路径<br>以上三种方法都可以试一下<br><a href="http://www.cnblogs.com/mengdeep/p/7487910.html" target="_blank" rel="noopener">参考资料</a></li></ol><h3 id="常驻内存时发生的事情"><a href="#常驻内存时发生的事情" class="headerlink" title="常驻内存时发生的事情"></a>常驻内存时发生的事情</h3><p>这个是 phper 很少碰到但是很常见的情况, 比如用 swoole 启动了一个常驻进程的服务, 那么就一定要小心使用静态变量,在同步模式下会发生变量污染, 还有就是 redis,mysql 这类的链接,你会发现长时间静置以后就会出现一些摸不着头脑的问题, 这种情况不妨想一下是不是 server 端回收了这个 socket,因此在 client 端怎么都写入不进去.  还有就是 php 在读取消息的时候,出现消息过长的情况,那么就要考虑EOF终止符的问题了… 单次 http 每一次请求都是全新的代码, 不用自己考虑 gc 的问题, 但是在常驻内存的时候,这些就是一个个的大坑了</p><h3 id="mysql-has-gone-away"><a href="#mysql-has-gone-away" class="headerlink" title="mysql has gone away"></a>mysql has gone away</h3><p>产生这个错误的主要原因是 mysql server 端断开了链接, client 端还拿着这个句柄去请求,解决方式有两种:</p><ol><li><p><code>show global variables like &#39;%timeout&#39;;</code> 查看 wait_timeout 的时长,适当的调长一点, 这种方法治标不治本,而且有隐患</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> global wait_timeout=10;</span><br><span class="line">mysql&gt; show global variables like <span class="string">'wait_timeout'</span>;</span><br></pre></td></tr></table></figure></li><li><p>使用 mysql 之前需要 mysql_ping() 一下, 如果出现断开的错误就启动重连机制</p></li></ol><h3 id="js-和-php-交互传中文参数的编解码问题"><a href="#js-和-php-交互传中文参数的编解码问题" class="headerlink" title="js 和 php 交互传中文参数的编解码问题"></a>js 和 php 交互传中文参数的编解码问题</h3><p>之前碰到了问题是:<br>在 php 端 urlencode 的值为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orderid%3D21111111110001954%26pid%3D257742%26reason%3D%E4%B8%AA%E4%BA%BA%E6%96%B9%E9%9D%A2%E5%8E%9F%E5%9B%A0_%E4%BD%BF%E7%94%A8%E7%BA%A2%E5%8C%85%E9%87%8D%E6%96%B0%E4%B8%8B%E5%8D%95%26token%3D041d9e5575f480b7bfd58b09bd14ab1c7ee9e9594f2fcdb9f0e3e39fc634b48f</span><br></pre></td></tr></table></figure></p><p>需要 urldecode 一次</p><p>而在 js 端的结果是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orderid%3D21111111110002170%26pid%3D257742%26reason%3D%25E4%25B8%25AA%25E4%25BA%25BA%25E6%2596%25B9%25E9%259D%25A2%25E5%258E%259F%25E5%259B%25A0_%25E4%25B8%25AA%25E4%25BA%25BA%25E8%25BA%25AB%25E4%25BD%2593%25E5%258E%259F%25E5%259B%25A0%26token%3D041d9e5575f480b7bfd58b09bd14ab1c7ee9e9594f2fcdb9f0e3e39fc634b48f</span><br></pre></td></tr></table></figure></p><p>需要 urldecode 两次</p><p>查阅资料后:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">在后端是PHP程序的情况下，保持前端Javascript和PHP之间传值的统一编码可以使用以下函数进行处理：</span><br><span class="line"> </span><br><span class="line">WEB前端JavaScript</span><br><span class="line"> </span><br><span class="line">编码：escape(encodeURI(string))</span><br><span class="line"> </span><br><span class="line">解码：unescape(decodeURI(string))</span><br><span class="line"> </span><br><span class="line">WEB后端Php</span><br><span class="line"> </span><br><span class="line">编码：urlencode(string)</span><br><span class="line"> </span><br><span class="line">解码：urldecode(urldecode(string))</span><br></pre></td></tr></table></figure></p><p><a href="https://bbs.csdn.net/topics/330072196" target="_blank" rel="noopener">为什么要encodeURI(url)两次才不会出现乱码？</a></p><h3 id="PHP中rawurlencode和urlencode、JS中encodeURI与encodeURIComponent-的区别"><a href="#PHP中rawurlencode和urlencode、JS中encodeURI与encodeURIComponent-的区别" class="headerlink" title="PHP中rawurlencode和urlencode、JS中encodeURI与encodeURIComponent 的区别"></a>PHP中rawurlencode和urlencode、JS中encodeURI与encodeURIComponent 的区别</h3><p>rawurlencode遵守是94年国际标准备忘录RFC 1738</p><p>urlencode实现的是传统做法，和上者的主要区别是对空格的转义是’+’而不是’%20’<br>javascript的encodeURL也是94年标准，而javascript的escape是另一种用”%xxx”标记unicode编码的方法。<br>推荐在PHP中使用用rawurlencode。弃用urlencode</p><p>样例<br>source:<br>超级无敌的人sadha sajdh数据样本sdls fhejrthcxzb.file.jpeg </p><p>PHP urlencode:<br>%E8%B6%85%E7%BA%A7%E6%97%A0%E6%95%8C%E7%9A%84%E4%BA%BAsadha+sajdh%E6%95%B0%E6%8D%AE%E6%A0%B7%E6%9C%ACsdls+fhejrthcxzb.file.jpeg </p><p>PHP rawurlencode:<br>%E8%B6%85%E7%BA%A7%E6%97%A0%E6%95%8C%E7%9A%84%E4%BA%BAsadha%20sajdh%E6%95%B0%E6%8D%AE%E6%A0%B7%E6%9C%ACsdls%20fhejrthcxzb.file.jpeg</p><p>Javascript encodeURI|encodeURIComponent:<br>%E8%B6%85%E7%BA%A7%E6%97%A0%E6%95%8C%E7%9A%84%E4%BA%BAsadha%20sajdh%E6%95%B0%E6%8D%AE%E6%A0%B7%E6%9C%ACsdls%20fhejrthcxzb.file.jpeg </p><p>Javascript escape:<br>%u8D85%u7EA7%u65E0%u654C%u7684%u4EBAsadha%20sajdh%u6570%u636E%u6837%u672Csdls%20fhejrthcxzb.file.jpeg</p><p><a href="https://blog.csdn.net/suofiya2008/article/details/6397168" target="_blank" rel="noopener">帖子原文</a></p><p>在前端还有个问题就是, js 的 <code>encodeURIComponent</code> 和 <code>encodeURI</code> 都不会转换 <code>_-.!~*&#39;()#</code> 这些保留字符, 而在后端的<code>rawurlencode</code> 则是会转换的, 因此需要前端单独把这几个给拎出来, 如下:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"*"</span>.charCodeAt(<span class="number">0</span>) <span class="comment">// 42</span></span><br><span class="line"><span class="built_in">String</span>.fromCharCode(<span class="number">42</span>) <span class="comment">// *</span></span><br></pre></td></tr></table></figure></p><p>这里有张图说的很明白<br><img src="http://blog-image.onlyoneip.com/urlencode.jpeg" alt=""><br><a href="https://www.zhihu.com/question/21861899/answer/91279362" target="_blank" rel="noopener">图片来源</a></p><h3 id="关于出现-lt-U-200B-gt-这种-zero-width-space-字符"><a href="#关于出现-lt-U-200B-gt-这种-zero-width-space-字符" class="headerlink" title="关于出现 &lt;U+200B&gt; 这种 zero-width space 字符"></a>关于出现 &lt;U+200B&gt; 这种 zero-width space 字符</h3><p>如果出现 <code>mb_substr</code> 这类操作的时候, 会出现字数判断错误的问题, 这个有时候很难排查, 因为在 win 上,使用命令行或者 linux 上用<code>cat</code>命令是看不到字符间是有 &lt;U+200B&gt; 的, 如下:<br><img src="http://blog-image.onlyoneip.com/zero-width%20space.png" alt=""></p><p>这玩意儿出现的场景就是: 在前端输入框中输入几个字, 然后复制粘贴.  这样尽管看起来之间没有空格, 但是其中还是插入了这个字符<br>这个就是 <a href="https://zh.wikipedia.org/wiki/%E9%9B%B6%E5%AE%BD%E7%A9%BA%E6%A0%BC" target="_blank" rel="noopener">zero-width space 零宽空格</a>, 处理的办法也很简单, 前端传值之前给过滤一下, 比如 <a href="https://stackoverflow.com/questions/7055600/u200b-zero-width-space-characters-in-my-js-code-where-did-they-come-from" target="_blank" rel="noopener">https://stackoverflow.com/questions/7055600/u200b-zero-width-space-characters-in-my-js-code-where-did-they-come-from</a> 或 <a href="https://codeday.me/bug/20171122/97765.html" target="_blank" rel="noopener">https://codeday.me/bug/20171122/97765.html</a></p><p>后端 php 处理的话和这个不一样, 使用 utf-8 的处理方式, 可以参考这篇文章 <a href="https://blog.csdn.net/qq_28018283/article/details/54136480" target="_blank" rel="noopener">特殊字符<200b><200c><200d>的删除办法与原理</200d></200c></200b></a></p><p>替换这种编码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$value = str_replace(<span class="string">"\xe2\x80\x8b"</span>, <span class="string">''</span>, $value);</span><br><span class="line">$value = str_replace(<span class="string">"\xe2\x80\x8c"</span>, <span class="string">''</span>, $value);</span><br><span class="line">$value = str_replace(<span class="string">"\xe2\x80\x8d"</span>, <span class="string">''</span>, $value);</span><br></pre></td></tr></table></figure></p><p>编码对照如下:<br><img src="http://blog-image.onlyoneip.com/zero-width-space-2.png" alt=""></p><h3 id="mac-设置crontab-e-：-“-usr-bin-vi”-exited-with-status-1"><a href="#mac-设置crontab-e-：-“-usr-bin-vi”-exited-with-status-1" class="headerlink" title="mac 设置crontab -e ： “/usr/bin/vi” exited with status 1"></a>mac 设置crontab -e ： “/usr/bin/vi” exited with status 1</h3><p>输入以下命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> EDITOR=vim</span><br><span class="line">sudo touch /etc/crontab</span><br><span class="line">crontab -e</span><br><span class="line">crontab -l</span><br></pre></td></tr></table></figure></p><p>把默认编辑器从 vi 改成 vim</p><p><a href="https://segmentfault.com/a/1190000013774374" target="_blank" rel="noopener">原文</a></p><h3 id="出现-The-“https-bower-herokuapp-com-packages-jquery-quot-file-could-not-be-downloaded-HTTP-1-1-502-Bad-Gateway"><a href="#出现-The-“https-bower-herokuapp-com-packages-jquery-quot-file-could-not-be-downloaded-HTTP-1-1-502-Bad-Gateway" class="headerlink" title="出现: The “https://bower.herokuapp.com/packages/jquery&quot; file could not be downloaded (HTTP/1.1 502 Bad Gateway)"></a>出现: The “<a href="https://bower.herokuapp.com/packages/jquery&quot;" target="_blank" rel="noopener">https://bower.herokuapp.com/packages/jquery&quot;</a> file could not be downloaded (HTTP/1.1 502 Bad Gateway)</h3><p>yii2 更新的时候静态资源出现问题, 执行 <code>composer global require &quot;fxp/composer-asset-plugin:~1.4.4&quot;</code></p><p><a href="https://stackoverflow.com/questions/51441090/yii2-bower-error-heroku" target="_blank" rel="noopener">问题来源</a></p><h3 id="出现-Jquery-UI-1-11-4-and-jquery-3-0-的版本兼容问题"><a href="#出现-Jquery-UI-1-11-4-and-jquery-3-0-的版本兼容问题" class="headerlink" title="出现: Jquery UI 1.11.4 and jquery 3.0 的版本兼容问题"></a>出现: Jquery UI 1.11.4 and jquery 3.0 的版本兼容问题</h3><p>这个是在部署 adminLTE + rbac 时候遇上的, 打开 <code>/admin/menu/create</code> 会报 <code>Jquery UI error - f.getClientRects is not a function</code> 错误</p><p>解决方法:<br>配置文件: config/web.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> <span class="string">'components'</span> =&gt; [</span><br><span class="line">     ...</span><br><span class="line">        <span class="comment">//静态资源</span></span><br><span class="line">        <span class="string">'assetManager'</span> =&gt; [</span><br><span class="line">            ...</span><br><span class="line">            <span class="string">'assetMap'</span> =&gt; [</span><br><span class="line">                <span class="string">'jquery.js'</span> =&gt; <span class="string">'https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js'</span>, <span class="comment">// </span></span><br><span class="line">                <span class="string">'jquery.min.js'</span> =&gt; <span class="string">'https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js'</span>,</span><br><span class="line"><span class="comment">//                'jquery.js' =&gt; '@web/js/jquery/jquery.js',</span></span><br><span class="line"><span class="comment">//                'jquery.min.js' =&gt; '@web/js/jquery/jquery.js',</span></span><br><span class="line">            ],</span><br><span class="line">            ...</span><br><span class="line">        ],</span><br><span class="line">    ...</span><br><span class="line"> ]</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p>把相应的 jquery 替换成 <code>v2.2.4</code> 解决<br><a href="https://stackoverflow.com/questions/37914869/jquery-ui-error-f-getclientrects-is-not-a-function" target="_blank" rel="noopener">问题来源</a></p><h3 id="macOS-brew安装php7-1-以及swoole扩展"><a href="#macOS-brew安装php7-1-以及swoole扩展" class="headerlink" title="macOS brew安装php7.1 以及swoole扩展"></a>macOS brew安装php7.1 以及swoole扩展</h3><p>brew改版后内核集成了php, 所以可以直接安装<br>安装php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install php@7.1</span><br></pre></td></tr></table></figure></p><p>按提示把<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH="/usr/local/opt/php@7.1/bin:$PATH"'</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH="/usr/local/opt/php@7.1/sbin:$PATH"'</span> &gt;&gt; ~/.zshrc</span><br></pre></td></tr></table></figure></p><p>这些放到你本地命令行配置里面, 然后生成一个软链<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew link php@7.1 --force</span><br></pre></td></tr></table></figure></p><p>安装扩展就得使用pecl工具了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/opt/php@7.1       <span class="comment"># 执行完 brew link 之后就按软链的来, 这样的好处就是不用记小版本号, 路径短</span></span><br><span class="line">pecl install swoole             <span class="comment"># 提示 'openssl/ssl.h' file not found 就是你安装的时候别选 ssl支持就行</span></span><br></pre></td></tr></table></figure></p><p>如果提示 <code>No releases available for package “pecl.php.net/swoole”</code><br>参考 <a href="https://blog.joefom.com/archives/137" target="_blank" rel="noopener">执行 ‘pecl install swoole’之后，遇到的一些坑</a> , 按提示一步步走应该没问题</p><p>安装完毕之后需要变一下配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">php -i | grep .ini</span><br><span class="line">...</span><br><span class="line">Loaded Configuration File =&gt; /usr/<span class="built_in">local</span>/etc/php/7.1/php.ini     //当前加载的配置文件路径</span><br><span class="line">...</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/etc/php/7.1</span><br></pre></td></tr></table></figure></p><p>先删除 php.ini 里面第一行的 <code>extension=swoole.so</code> 改成这个so文件的真实路径, 推荐放到隔壁的 conf.d 目录底下<br>然后<code>php -m | grep sw</code> 可以看一下了<br>安装其他扩展也是按这个路数来</p><h3 id="出现-Connection-reset-by-peer-报错"><a href="#出现-Connection-reset-by-peer-报错" class="headerlink" title="出现 Connection reset by peer 报错"></a>出现 Connection reset by peer 报错</h3><p>这是个tcp链接上的错误, 意味着 <code>链接过程中读或者写出现异常</code>, 出现的原因:</p><ol><li>AB两端, A端关闭了链接, B端仍在发送, 则抛异常</li><li>AB两端, A退出但没关闭链接, 则B在读的时候抛异常</li></ol><p>排查:</p><ol><li>先看看server端是不是对包大小进行了限制, buffer分配是否足够</li><li>是不是程序链接到上限了, 被服务器误杀</li><li>防火墙问题</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这里做一些备注,以防再次碰到&lt;br&gt;
    
    </summary>
    
      <category term="php" scheme="http://blog.justwe.site/categories/php/"/>
    
    
      <category term="php" scheme="http://blog.justwe.site/tags/php/"/>
    
      <category term="debug" scheme="http://blog.justwe.site/tags/debug/"/>
    
  </entry>
  
  <entry>
    <title>通过 Docker-Compose 搭建一个 Elk</title>
    <link href="http://blog.justwe.site/2018/08/20/docker-elk/"/>
    <id>http://blog.justwe.site/2018/08/20/docker-elk/</id>
    <published>2018-08-20T06:57:47.000Z</published>
    <updated>2018-08-21T06:24:52.695Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>找了不少使用 docker-elk 搭建的博客, 英文的阅读吃力不说, 镜像源也是慢的让人头皮发麻, 因此重新编排了一个<code>docker-compose</code>,源都是从 <a href="https://hub.docker.com/" target="_blank" rel="noopener">https://hub.docker.com/</a> 上找的, 即使拉的国内镜像源应该也能很好的支持了吧?</p></blockquote><a id="more"></a><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul><li>Docker          <code>18.06.0-ce</code></li><li>docker-compose  <code>1.22.0</code><br>给每个容器最少分配 1G 的内存</li></ul><h3 id="软件版本"><a href="#软件版本" class="headerlink" title="软件版本"></a>软件版本</h3><ul><li>logstash:         <code>5.*</code></li><li>elasticsearch:    <code>5.*</code></li><li>kibana:           <code>5.*</code></li></ul><h3 id="启动前的配置"><a href="#启动前的配置" class="headerlink" title="启动前的配置"></a>启动前的配置</h3><p>在各个目录下都有对应的 config 配置, 根据各自的情况自行处理</p><p>拿默认的 logstash/confg/test.conf 中的配置举例:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">      file &#123;</span><br><span class="line">          <span class="comment">#这里的路径指的是 logstash 容器中的路径, 外部接入需要使用 volume 进行目录映射 </span></span><br><span class="line">            path =&gt; <span class="string">"/logs/input/*"</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 在 logstash 容器中的输入</span></span><br><span class="line">      stdin &#123;&#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment"># 因为做了本地5000端口和容器5000端口进行绑定, 所以可以用 nc 工具测试一下</span></span><br><span class="line">      <span class="comment"># echo "Test Logstash TCP Input Plugin" | nc localhost 5000</span></span><br><span class="line">      tcp &#123;</span><br><span class="line">            <span class="built_in">type</span> =&gt; <span class="string">"tcp"</span></span><br><span class="line">            port =&gt; 5000</span><br><span class="line">            mode =&gt; <span class="string">"server"</span></span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">      file &#123;</span><br><span class="line">          <span class="comment">#这里的路径指的是 logstash 容器中的路径, 外部接入需要使用 volume 进行目录映射</span></span><br><span class="line">            path =&gt; <span class="string">"/logs/output/%&#123;+yyyy-MM-dd-HH&#125;/%&#123;host&#125;.log"</span></span><br><span class="line">      &#125;</span><br><span class="line">      stdout &#123;</span><br><span class="line">            codec =&gt; rubydebug</span><br><span class="line">      &#125;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">    hosts =&gt; <span class="string">"elasticsearch:9200"</span></span><br><span class="line">        <span class="comment"># 这里设置的 index 在 kibana 中会用到</span></span><br><span class="line">            index =&gt; <span class="string">"file-log-%&#123;+YYYY.MM&#125;"</span>  </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h3><p>执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/gaopengfei123123/docker-elk.git &amp;&amp; cd docker-elk</span><br><span class="line">docker-compose up -d --build</span><br></pre></td></tr></table></figure></p><p>等一会看到执行成功的提示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Creating docker-elk_elasticsearch_1 ... done</span><br><span class="line">Creating docker-elk_logstash_1      ... done</span><br><span class="line">Creating docker-elk_kibana_1        ... done</span><br></pre></td></tr></table></figure></p><p>在本地浏览器输入 <code>http://localhost:5601/</code> 进入 kibana 界面</p><p><strong>注意</strong>, 第一次启动时有可能会出现提示 <code>elasticsearch not found</code> 这类的问题, 可以先等个一两分钟刷新一下就好了, 如果还是不行就谷歌或者提 issue 解决一下</p><p>同目录下输入<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose stop</span><br></pre></td></tr></table></figure></p><p>则停止所有服务</p><h3 id="测试一下"><a href="#测试一下" class="headerlink" title="测试一下"></a>测试一下</h3><p>在 <code>logs/input/</code> 目录下新增个 test.log 文件, 然后输入点东西验证一下, 或者命令行执行<code>echo &quot;Test Logstash TCP Input Plugin&quot; | nc localhost 5000</code> 通过 tcp 发送日志</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs -f</span><br></pre></td></tr></table></figure><p>查看各容器日志输出</p><h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><ul><li>引入 kafka 做缓冲 </li><li>搭建 es 集群</li></ul><p><a href="https://github.com/gaopengfei123123/docker-elk" target="_blank" rel="noopener">github 地址</a></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;找了不少使用 docker-elk 搭建的博客, 英文的阅读吃力不说, 镜像源也是慢的让人头皮发麻, 因此重新编排了一个&lt;code&gt;docker-compose&lt;/code&gt;,源都是从 &lt;a href=&quot;https://hub.docker.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://hub.docker.com/&lt;/a&gt; 上找的, 即使拉的国内镜像源应该也能很好的支持了吧?&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="docker" scheme="http://blog.justwe.site/categories/docker/"/>
    
    
      <category term="docker" scheme="http://blog.justwe.site/tags/docker/"/>
    
      <category term="elk" scheme="http://blog.justwe.site/tags/elk/"/>
    
  </entry>
  
</feed>
